<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Daer ‚Äì Dienstleister | TV (Flex)</title>
<style>
:root{
  --bg:#0b1020;
  --card:#141c30;
  --text:#fff;
  --muted:rgba(255,255,255,.72);
  --header:#1c2842;
  --border:#2b3a55;
  --accent:#4cc9f0;
  --today:rgba(0,255,204,.9);
  --shadow:0 10px 28px rgba(0,0,0,.25);

  --radius:22px;
  --gap:10px;

  /* Layout vars ‚Äì computed by JS */
  --dayhead-h: clamp(40px, 5.2vh, 66px);
  --name-col: minmax(150px, 18vw);
  --chip-font: 13px;
  --chip-pad-y: 5px;
  --chip-pad-x: 9px;
  --chip-gap: 6px;
  --row-min: 46px;
}
body.light{
  --bg:#f0f4f8;
  --card:#ffffff;
  --text:#1a202c;
  --muted:rgba(26,32,44,.72);
  --header:#e6f7f9;
  --border:#cbd5e0;
  --accent:#00acc1;
  --today:rgba(0,172,193,.9);
  --shadow:0 14px 28px rgba(0,0,0,.10);
}

html,body{
  height:100%;
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:var(--text);
  overflow:hidden;
  transition:background .2s,color .2s;
}
*{box-sizing:border-box}

.wrapper{
  height:100%;
  padding:2vh 2vw;
  display:flex;
  flex-direction:column;
  gap:1vh;
}

/* Top */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:1vw;
}
.brand{min-width:0}
h1{
  margin:0;
  font-weight:950;
  letter-spacing:.2px;
  font-size:clamp(18px, 3.1vh, 34px);
  line-height:1.05;
}
.meta{
  display:flex;
  flex-wrap:wrap;
  gap:1vw;
  align-items:center;
  margin-top:.5vh;
  color:var(--muted);
  font-size:clamp(12px, 1.6vh, 18px);
}
.meta .clock{
  color:var(--accent);
  font-weight:950;
  font-size:clamp(14px, 2.1vh, 22px);
}
.pills{
  display:flex;
  flex-wrap:wrap;
  gap:.6vw;
  align-items:center;
  justify-content:flex-end;
}
.pill{
  background:var(--card);
  border:2px solid rgba(76,201,240,.22);
  box-shadow:var(--shadow);
  padding:.6vh .9vw;
  border-radius:999px;
  font-weight:850;
  font-size:clamp(12px, 1.5vh, 18px);
  white-space:nowrap;
}
.pill strong{color:var(--accent)}
.btn{
  background:var(--card);
  border:2px solid var(--accent);
  color:var(--text);
  box-shadow:var(--shadow);
  padding:.65vh 1vw;
  border-radius:14px;
  font-weight:950;
  cursor:pointer;
  font-size:clamp(12px, 1.6vh, 18px);
  transition:transform .15s;
}
.btn:hover{transform:scale(1.04)}

/* Week nav */
.week-nav{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:2.2vw;
}
.week-nav button{
  background:transparent;
  color:var(--text);
  opacity:.6;
  border:1px solid transparent;
  padding:.45vh 1vw;
  border-radius:12px;
  cursor:pointer;
  font-weight:800;
  font-size:clamp(12px, 1.6vh, 18px);
  transition:.15s;
}
.week-nav button:hover:not(:disabled){
  opacity:1;
  border-color:rgba(76,201,240,.35);
  background:rgba(76,201,240,.10);
}
.week-nav button:disabled{opacity:.18; cursor:not-allowed;}
.week-info{
  text-align:center;
  min-width:min(56vw, 560px);
}
.week-number{
  color:var(--accent);
  font-weight:950;
  font-size:clamp(14px, 2.0vh, 22px);
}
.week-date{
  color:var(--muted);
  font-weight:800;
  font-size:clamp(11px, 1.35vh, 16px);
  margin-top:.15vh;
}

/* Panel */
.panel{
  flex:1;
  min-height:0;
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:1.2vh 1.2vw;
  display:flex;
  flex-direction:column;
  gap:.9vh;
}

/* Controls */
.controls{
  display:flex;
  gap:10px;
  align-items:end;
  flex-wrap:wrap;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:16px;
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.02));
}
body.light .controls{
  background: linear-gradient(180deg, rgba(0,0,0,.03), rgba(255,255,255,.6));
}
.group{display:flex; flex-direction:column; gap:6px; min-width:180px;}
.group label{font-size:12px; color:var(--muted); letter-spacing:.02em;}
select{
  appearance:none; -webkit-appearance:none;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background: rgba(0,0,0,.18);
  color: var(--text);
  outline:none;
  font-weight:850;
}
body.light select{background:#fff; color:#081018;}
.hint{
  flex:1 1 260px;
  min-width:260px;
  padding:8px 10px;
  border-radius:12px;
  border:1px dashed rgba(255,255,255,.18);
  color:var(--muted);
  font-size:13px;
}
body.light .hint{border-color:rgba(0,0,0,.12);}

.pagebar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:6px 2px 0 2px;
  color:var(--muted);
  font-weight:850;
  font-size:13px;
}
.pagebar .pagepill{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(76,201,240,.25);
  padding:6px 10px;
  border-radius:999px;
  color:var(--text);
  white-space:nowrap;
}

/* Grid Area (no scroll) */
.stage{
  flex:1;
  min-height:0;
  border-radius:16px;
  border:3px solid var(--border);
  background:var(--border);
  overflow:hidden; /* no scroll, we paginate */
}

/* Classic schedule grid */
.grid{
  display:grid;
  height:100%;
  grid-template-columns: var(--name-col) repeat(var(--day-count), minmax(0, 1fr));
  grid-template-rows: var(--dayhead-h) repeat(var(--rows), minmax(var(--row-min), 1fr));
  gap:2px;
}
.cell, .head{
  background:var(--card);
  overflow:hidden;
  min-height:0;
}
.head{
  background:var(--header);
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  gap:2px;
  padding:8px 8px;
  font-weight:950;
  position:relative;
}
.head.corner{
  align-items:flex-start;
  justify-content:center;
  padding-left:14px;
}
.head .dayName{color:var(--accent); font-size:clamp(12px, 1.85vh, 22px); line-height:1.05;}
.head .dayDate{color:var(--muted); font-size:clamp(10px, 1.2vh, 14px); font-weight:850;}
.head.emp{
  justify-content:flex-start;
  flex-direction:row;
  gap:10px;
  padding-left:14px;
}
.dot{
  width:clamp(12px, 1.0vw, 18px);
  height:clamp(12px, 1.0vw, 18px);
  border-radius:999px;
  border:2px solid rgba(255,255,255,.85);
  flex:0 0 auto;
}
.empname{
  font-weight:950;
  font-size:clamp(12px, 1.55vh, 18px);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:100%;
}

.cell{
  padding:8px 10px;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  gap:var(--chip-gap);
}
.chips{
  display:flex;
  flex-direction:column;
  gap:var(--chip-gap);
  min-height:0;
}
.chip{
  padding: var(--chip-pad-y) var(--chip-pad-x);
  border-radius:10px;
  font-weight:950;
  font-size: var(--chip-font);
  line-height:1.05;
  box-shadow:0 2px 10px rgba(0,0,0,.14);
  white-space:normal;
  overflow-wrap:anywhere;
}
.empty{opacity:.16}

.today{
  outline:4px solid var(--today);
  box-shadow:0 0 42px var(--today);
  position:relative;
}
.today::before{
  content:"";
  position:absolute; inset:0;
  background:var(--today);
  opacity:.08;
  pointer-events:none;
}

/* Banner */
.banner{
  position:fixed;
  left:50%;
  top:1.6vh;
  transform:translateX(-50%);
  background:rgba(249,65,68,.95);
  border:2px solid rgba(255,255,255,.25);
  border-radius:16px;
  padding:1.2vh 2.2vw;
  font-weight:950;
  display:none;
  box-shadow:0 18px 36px rgba(0,0,0,.40);
  font-size:clamp(14px, 2.0vh, 22px);
  z-index:50;
}

/* Mobile tweaks */
@media (max-width: 820px){
  .wrapper{padding:1.2vh 3vw;}
  .group{min-width:150px;}
  .hint{min-width:100%;}
  :root{ --name-col: minmax(140px, 32vw); }
}
</style>
</head>

<body>
<div class="wrapper">
  <div class="topbar">
    <div class="brand">
      <h1>Daer ‚Äì Dienstleister</h1>
      <div class="meta">
        <div class="clock" id="clock">--:--:--</div>
        <div id="todayDate"></div>
        <div id="month"></div>
        <div id="weather"></div>
      </div>
    </div>
    <div class="pills">
      <div class="pill" id="statsPill">Einsatz: <strong>0</strong> ‚Ä¢ Urlaub: <strong>0</strong> ‚Ä¢ Krank: <strong>0</strong> ‚Ä¢ Frei: <strong>0</strong></div>
      <button class="btn" id="themeBtn" title="Hell/Dunkel">üåì</button>
    </div>
  </div>

  <div class="week-nav">
    <button id="prevWeek">‚Üê Vorherige</button>
    <div class="week-info">
      <div class="week-number" id="weekNumber">Woche 1</div>
      <div class="week-date" id="weekDate">‚Äì</div>
    </div>
    <button id="nextWeek">N√§chste ‚Üí</button>
  </div>

  <div class="panel" id="panel">
    <div class="controls" id="controls">
      <div class="group">
        <label for="viewMode">Ansicht</label>
        <select id="viewMode">
          <option value="week">Woche komplett</option>
          <option value="today">Heute (nur heutiger Tag)</option>
        </select>
      </div>
      <div class="group">
        <label for="empMode">Mitarbeiter</label>
        <select id="empMode">
          <option value="auto">Auto (leer ausblenden)</option>
          <option value="all12">Alle 12 (auch leer)</option>
          <option value="one">Einzelperson‚Ä¶</option>
        </select>
      </div>
      <div class="group" id="empPickWrap" style="display:none;">
        <label for="empPick">Wer?</label>
        <select id="empPick">
          <option value="0">‚Äì</option>
        </select>
      </div>
      <div class="group">
        <label for="rotate">TV Modus</label>
        <select id="rotate">
          <option value="on">Auto-Seitenwechsel: AN</option>
          <option value="off">Auto-Seitenwechsel: AUS</option>
        </select>
      </div>
      <div class="hint" id="hint">Flex-Ansicht: wenn‚Äôs zu voll wird, teilt dit System automatisch in Seiten (ohne Scroll). Du siehst alles ‚Äì Seite f√ºr Seite.</div>
    </div>

    <div class="pagebar">
      <div class="pagepill" id="pageInfo">Seite 1/1</div>
      <div class="pagepill" id="densityInfo">‚Äì</div>
    </div>

    <div class="stage" id="stage"></div>
  </div>
</div>

<div class="banner" id="banner">üö® Krank gemeldet</div>

<script type="module">
const firebaseConfig = {
  apiKey: "AIzaSyDgjZr2yrOrbl2dUoY26fl8EenOL0Hh-H4",
  authDomain: "daer-b525e.firebaseapp.com",
  databaseURL: "https://daer-b525e-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "daer-b525e",
  storageBucket: "daer-b525e.firebasestorage.app",
  messagingSenderId: "992532370590",
  appId: "1:992532370590:web:185d52a3dc6338b3ee978f"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const planRef = ref(db, "dienstplan");
const eventsRef = query(ref(db,"events"), limitToLast(1));

const $ = (id)=>document.getElementById(id);

let planData = null;
let currentWeekIndex = 0;

let viewMode = localStorage.getItem("tvx-view") || "week"; // week|today
let empMode  = localStorage.getItem("tvx-empMode") || "auto"; // auto|all12|one
let empPick  = localStorage.getItem("tvx-empPick") || "0";
let rotate   = localStorage.getItem("tvx-rotate") || "on";

let pages = [];
let pageIndex = 0;
let rotateTimer = null;

function setSelect(id, val){ const el=$(id); if(el) el.value = val; }

const savedTheme = localStorage.getItem("tvx-theme");
if(savedTheme === "light") document.body.classList.add("light");
$("themeBtn").onclick = ()=>{
  document.body.classList.toggle("light");
  localStorage.setItem("tvx-theme", document.body.classList.contains("light") ? "light" : "dark");
};

function tick(){ $("clock").textContent = new Date().toLocaleTimeString("de-DE"); }
setInterval(tick, 1000); tick();

function tickDate(){
  const now = new Date();
  $("todayDate").textContent = now.toLocaleDateString("de-DE", {weekday:"long", day:"2-digit", month:"long", year:"numeric"});
}
setInterval(tickDate, 60*1000); tickDate();

function updateMonth(startISO){
  if(!startISO) return;
  const d=new Date(startISO);
  $("month").textContent = d.toLocaleDateString("de-DE",{month:"long", year:"numeric"});
}

async function loadWeather(){
  const url="https://api.open-meteo.com/v1/forecast?latitude=52.69&longitude=13.17&current_weather=true";
  try{
    const res=await fetch(url,{cache:"no-store"});
    const j=await res.json();
    $("weather").textContent = "Velten üå§ " + Math.round(j.current_weather.temperature) + "¬∞C";
  }catch(e){
    $("weather").textContent = "Velten üå§ ‚Ä¶";
  }
}
setInterval(loadWeather, 10*60*1000); loadWeather();

function todayISO(){
  const d=new Date();
  const p=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
}
function diffDays(aIso,bIso){
  const a=new Date(aIso), b=new Date(bIso);
  return Math.floor((b-a)/(1000*60*60*24));
}
function addDays(iso, days){
  if(!iso) return "";
  const d=new Date(iso);
  d.setDate(d.getDate()+days);
  return d.toISOString().slice(0,10);
}
function formatDate(iso){
  if(!iso) return "";
  const d=new Date(iso);
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yy=d.getFullYear();
  return `${dd}.${mm}.${yy}`;
}
function isDark(hex){
  if(!hex || hex[0]!=="#" || hex.length<7) return false;
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  const lum=(0.2126*r+0.7152*g+0.0722*b)/255;
  return lum<0.55;
}
function esc(s){
  return (s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function findCurrentWeek(startDate){
  const age = diffDays(startDate, todayISO());
  if(age >= 0 && age < 28) return Math.floor(age/7);
  return 0;
}

function syncControls(){
  setSelect("viewMode", viewMode);
  setSelect("empMode", empMode);
  setSelect("rotate", rotate);
  $("empPickWrap").style.display = (empMode === "one") ? "flex" : "none";
  setSelect("empPick", empPick);
}
$("viewMode").addEventListener("change",(e)=>{ viewMode=e.target.value; localStorage.setItem("tvx-view", viewMode); recomputeAndRender(true); });
$("empMode").addEventListener("change",(e)=>{ empMode=e.target.value; localStorage.setItem("tvx-empMode", empMode); $("empPickWrap").style.display = (empMode==="one")?"flex":"none"; recomputeAndRender(true); });
$("empPick").addEventListener("change",(e)=>{ empPick=e.target.value; localStorage.setItem("tvx-empPick", empPick); recomputeAndRender(true); });
$("rotate").addEventListener("change",(e)=>{ rotate=e.target.value; localStorage.setItem("tvx-rotate", rotate); setupRotation(); });

$("prevWeek").onclick = ()=>{ if(currentWeekIndex>0){ currentWeekIndex--; recomputeAndRender(true); } };
$("nextWeek").onclick = ()=>{ if(currentWeekIndex<3){ currentWeekIndex++; recomputeAndRender(true); } };
document.addEventListener("keydown",(e)=>{
  if(e.key==="ArrowLeft" && currentWeekIndex>0){ currentWeekIndex--; recomputeAndRender(true); }
  if(e.key==="ArrowRight" && currentWeekIndex<3){ currentWeekIndex++; recomputeAndRender(true); }
  if(e.key==="PageDown"){ pageIndex = Math.min(pages.length-1, pageIndex+1); renderPage(); setupRotation(); }
  if(e.key==="PageUp"){ pageIndex = Math.max(0, pageIndex-1); renderPage(); setupRotation(); }
});
window.addEventListener("resize", ()=>{ clearTimeout(window.__rT); window.__rT=setTimeout(()=>recomputeAndRender(false), 160); });

function getDayIndices(){
  const age = planData?.start ? diffDays(planData.start, todayISO()) : -1;
  const todayWeek = (age>=0 && age<28) ? Math.floor(age/7) : -1;
  const todayDay  = (age>=0 && age<28) ? (age%7) : -1;

  let ds = [0,1,2,3,4,5];
  if(viewMode === "today"){
    if(currentWeekIndex === todayWeek && todayDay>=0 && todayDay<=5) ds = [todayDay];
    else ds = [0];
  }
  return {ds, todayWeek, todayDay};
}
function employeeHasAny(weekIdx, empIdx, dayIndices){
  for(const d of dayIndices){
    const k = `${weekIdx}-${empIdx}-${d}`;
    const items = (planData.assignments && planData.assignments[k]) ? planData.assignments[k] : [];
    if(items && items.length) return true;
  }
  return false;
}
function computeDensity(empIndices, dayIndices, weekIdx){
  let maxItems = 0, total = 0, cells = 0;
  for(const ei of empIndices){
    for(const d of dayIndices){
      const k = `${weekIdx}-${ei}-${d}`;
      const items = (planData.assignments && planData.assignments[k]) ? planData.assignments[k] : [];
      const n = items ? items.length : 0;
      if(n){ total += n; cells++; }
      if(n > maxItems) maxItems = n;
    }
  }
  const avg = cells ? (total / cells) : 0;
  return {maxItems, total, avg: Math.round(avg*10)/10};
}
function applyCompactness(density){
  const mi = density.maxItems || 0;
  let font = 13, py = 5, px = 9, gap = 6, rowMin = 46;
  if(mi >= 9){ font = 10.5; py = 3; px = 6; gap = 3; rowMin = 38; }
  else if(mi >= 7){ font = 11; py = 3; px = 6; gap = 3; rowMin = 40; }
  else if(mi >= 6){ font = 11.5; py = 3.5; px = 7; gap = 4; rowMin = 42; }
  else if(mi >= 5){ font = 12; py = 4; px = 7; gap = 4; rowMin = 44; }
  document.documentElement.style.setProperty("--chip-font", font + "px");
  document.documentElement.style.setProperty("--chip-pad-y", py + "px");
  document.documentElement.style.setProperty("--chip-pad-x", px + "px");
  document.documentElement.style.setProperty("--chip-gap", gap + "px");
  document.documentElement.style.setProperty("--row-min", rowMin + "px");
}
function computePages(){
  const EMP_COUNT = 12;
  const allEmployees = (planData.employees||[]).slice(0, EMP_COUNT);
  const {ds} = getDayIndices();

  let baseIdx = [...Array(allEmployees.length).keys()];
  if(empMode === "auto"){
    baseIdx = baseIdx.filter(i=>employeeHasAny(currentWeekIndex, i, ds));
    if(baseIdx.length === 0) baseIdx = [...Array(allEmployees.length).keys()];
  } else if(empMode === "one"){
    baseIdx = [Number(empPick)||0];
  }

  const dens = computeDensity(baseIdx, ds, currentWeekIndex);
  applyCompactness(dens);

  const panel = $("panel");
  const controls = $("controls");
  const pagebar = document.querySelector(".pagebar");
  const panelH = panel.getBoundingClientRect().height;
  const controlsH = controls.getBoundingClientRect().height;
  const pagebarH = pagebar.getBoundingClientRect().height;
  const padding = 26;
  const avail = Math.max(200, panelH - controlsH - pagebarH - padding);
  const headH = 72;
  const rowMin = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--row-min")) || 46;

  let maxRows = Math.floor((avail - headH) / rowMin);
  maxRows = Math.max(3, Math.min(12, maxRows));

  const penalty = Math.floor(Math.max(0, (dens.maxItems - 3) * 0.6));
  const rowsPerPage = Math.max(3, Math.min(maxRows, maxRows - penalty));

  const out = [];
  for(let i=0; i<baseIdx.length; i += rowsPerPage) out.push(baseIdx.slice(i, i+rowsPerPage));

  $("densityInfo").textContent = `Dichte: max ${dens.maxItems} ‚Ä¢ √ò ${dens.avg} ‚Ä¢ Eintr√§ge ${dens.total}`;
  return out;
}

function buildGrid(empIndices){
  const stage = $("stage");
  stage.innerHTML = "";

  const EMP_COUNT = 12;
  const employeesAll = (planData.employees||[]).slice(0, EMP_COUNT);

  const weekStart = addDays(planData.start, currentWeekIndex * 7);
  const weekEnd = addDays(weekStart, 5);

  $("weekNumber").textContent = `Woche ${currentWeekIndex + 1}`;
  $("weekDate").textContent = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
  updateMonth(planData.start);

  const {ds, todayWeek, todayDay} = getDayIndices();
  document.documentElement.style.setProperty("--day-count", String(ds.length));
  document.documentElement.style.setProperty("--rows", String(empIndices.length));

  const dayNames = ["Mo","Di","Mi","Do","Fr","Sa"];
  const templates = planData.templates || [];
  const tByName = new Map(templates.map(t=>[t.name,t]));

  let stats = {einsatz:0, urlaub:0, krank:0, frei:0};

  const grid = document.createElement("div");
  grid.className = "grid";

  const corner = document.createElement("div");
  corner.className = "head corner";
  corner.innerHTML = `<div class="empname">Mitarbeiter</div>`;
  grid.appendChild(corner);

  ds.forEach((d)=>{
    const dateISO = addDays(weekStart, d);
    const h = document.createElement("div");
    h.className = "head";
    const label = (viewMode==="today" && ds.length===1) ? "Heute" : dayNames[d];
    h.innerHTML = `<div class="dayName">${label}</div><div class="dayDate">${formatDate(dateISO)}</div>`;
    grid.appendChild(h);
  });

  empIndices.forEach((empIdx)=>{
    const emp = employeesAll[empIdx] || {name:"‚Äî", color:"#4cc9f0"};
    const eh = document.createElement("div");
    eh.className = "head emp";
    eh.innerHTML = `<span class="dot" style="background:${emp.color||"#4cc9f0"}"></span><span class="empname">${esc(emp.name)}</span>`;
    grid.appendChild(eh);

    ds.forEach((d)=>{
      const k = `${currentWeekIndex}-${empIdx}-${d}`;
      const items = (planData.assignments && planData.assignments[k]) ? planData.assignments[k] : [];
      const c = document.createElement("div");
      c.className = "cell";

      if(currentWeekIndex === todayWeek && d === todayDay) c.classList.add("today");

      if(!items || items.length===0){
        c.classList.add("empty");
      }else{
        const wrap = document.createElement("div");
        wrap.className = "chips";
        items.forEach((name)=>{
          const tpl = tByName.get(name) || {name, type:"einsatz", color: emp.color || "#4cc9f0"};
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.style.background = tpl.color || (emp.color || "#4cc9f0");
          chip.style.color = isDark(chip.style.background) ? "#fff" : "#081018";
          chip.textContent = name;

          if(tpl.type==="urlaub") stats.urlaub++;
          else if(tpl.type==="krank") stats.krank++;
          else if(tpl.type==="frei") stats.frei++;
          else stats.einsatz++;

          wrap.appendChild(chip);
        });
        c.appendChild(wrap);
      }
      grid.appendChild(c);
    });
  });

  stage.appendChild(grid);

  $("statsPill").innerHTML = `Einsatz: <strong>${stats.einsatz}</strong> ‚Ä¢ Urlaub: <strong>${stats.urlaub}</strong> ‚Ä¢ Krank: <strong>${stats.krank}</strong> ‚Ä¢ Frei: <strong>${stats.frei}</strong>`;
  $("prevWeek").disabled = currentWeekIndex === 0;
  $("nextWeek").disabled = currentWeekIndex === 3;
}

function renderPage(){
  if(!pages.length) pages = [[]];
  pageIndex = Math.max(0, Math.min(pageIndex, pages.length-1));
  const empIndices = pages[pageIndex];
  $("pageInfo").textContent = `Seite ${pageIndex+1}/${pages.length} ‚Ä¢ Woche: ‚Üê/‚Üí ‚Ä¢ Seite: Bild‚Üë/‚Üì`;
  buildGrid(empIndices);
  document.documentElement.requestFullscreen?.().catch(()=>{});
}

function setupRotation(){
  if(rotateTimer) clearInterval(rotateTimer);
  rotateTimer = null;
  if(rotate !== "on" || pages.length <= 1) return;
  rotateTimer = setInterval(()=>{
    pageIndex = (pageIndex + 1) % pages.length;
    renderPage();
  }, 9000);
}

function recomputeAndRender(resetPage=false){
  if(!planData) return;
  if(resetPage) pageIndex = 0;
  pages = computePages();
  pageIndex = Math.max(0, Math.min(pageIndex, pages.length-1));
  renderPage();
  setupRotation();
}

onValue(planRef,(snap)=>{
  if(!snap.exists()) return;
  planData = snap.val();
  currentWeekIndex = findCurrentWeek(planData.start);

  const EMP_COUNT = 12;
  const employees = (planData.employees||[]).slice(0, EMP_COUNT);
  $("empPick").innerHTML = employees.map((e,idx)=>`<option value="${idx}">${esc(e.name)}</option>`).join("");
  if(Number(empPick) >= employees.length) empPick = "0";

  syncControls();
  recomputeAndRender(true);
});

onValue(eventsRef,(snap)=>{
  if(!snap.exists()) return;
  const obj = snap.val();
  const lastKey = Object.keys(obj)[0];
  const ev = obj[lastKey];
  if(ev?.type==="krank"){
    const b=$("banner");
    b.textContent = `üö® Krank gemeldet: ${ev.label} (${new Date(ev.at).toLocaleTimeString("de-DE")})`;
    b.style.display="block";
    setTimeout(()=>b.style.display="none", 8000);
  }
});
</script>
</body>
</html>
