<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#00acc1">
<title>Daer Dienstplan Pro</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --primary: #00acc1;
  --primary-dark: #008c9e;
  --secondary: #8b5cf6;
  --bg: #f5f7fa;
  --card: #ffffff;
  --text: #1a202c;
  --text-light: #718096;
  --border: #e2e8f0;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  --purple: #8b5cf6;
  --pink: #ec4899;
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
}

body.dark {
  --primary: #4cc9f0;
  --primary-dark: #00acc1;
  --secondary: #a78bfa;
  --bg: #0f1419;
  --card: #1a1f2e;
  --text: #e2e8f0;
  --text-light: #94a3b8;
  --border: #2d3748;
}

body.auto-dark {
  --primary: #4cc9f0;
  --bg: #0f1419;
  --card: #1a1f2e;
  --text: #e2e8f0;
  --text-light: #94a3b8;
  --border: #2d3748;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  -webkit-font-smoothing: antialiased;
  transition: background 0.3s, color 0.3s;
}

.app {
  height: 100%;
  display: flex;
  flex-direction: column;
  padding-top: var(--safe-top);
  padding-bottom: var(--safe-bottom);
}

/* Splash Screen */
.splash {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  animation: fadeOut 0.5s 2s forwards;
}

@keyframes fadeOut {
  to {
    opacity: 0;
    pointer-events: none;
  }
}

.splash-logo {
  font-size: 80px;
  animation: bounce 1s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}

.splash-text {
  color: white;
  font-size: 28px;
  font-weight: 900;
  margin-top: 20px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* Header */
.header {
  background: var(--card);
  box-shadow: 0 2px 12px rgba(0,0,0,0.1);
  position: relative;
  z-index: 100;
  animation: slideDown 0.5s;
}

@keyframes slideDown {
  from { transform: translateY(-100%); }
  to { transform: translateY(0); }
}

.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
}

.header-title h1 {
  font-size: 22px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--primary), var(--secondary), var(--pink));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: gradientShift 3s infinite;
}

@keyframes gradientShift {
  0%, 100% { filter: hue-rotate(0deg); }
  50% { filter: hue-rotate(30deg); }
}

.header-info {
  display: flex;
  gap: 12px;
  font-size: 13px;
  color: var(--text-light);
  font-weight: 600;
  margin-top: 4px;
}

.clock {
  color: var(--primary);
  font-weight: 800;
  animation: glow 2s infinite;
}

@keyframes glow {
  0%, 100% { text-shadow: 0 0 5px var(--primary); }
  50% { text-shadow: 0 0 15px var(--primary); }
}

.online-indicator {
  width: 8px;
  height: 8px;
  background: var(--success);
  border-radius: 50%;
  animation: blink 2s infinite;
  margin-left: 4px;
  display: inline-block;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.header-actions {
  display: flex;
  gap: 8px;
}

.icon-btn {
  background: var(--bg);
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  position: relative;
}

.icon-btn:active {
  transform: scale(0.85) rotate(10deg);
  background: var(--primary);
}

.icon-btn.active {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  animation: rotateIcon 0.5s;
}

@keyframes rotateIcon {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.badge {
  position: absolute;
  top: -2px;
  right: -2px;
  background: var(--danger);
  color: white;
  font-size: 10px;
  font-weight: 900;
  padding: 2px 5px;
  border-radius: 10px;
  min-width: 18px;
  text-align: center;
  animation: wiggle 1s infinite;
}

@keyframes wiggle {
  0%, 100% { transform: rotate(-5deg); }
  50% { transform: rotate(5deg); }
}

/* Speed Dial FAB */
.speed-dial {
  position: fixed;
  right: 20px;
  bottom: calc(20px + var(--safe-bottom));
  z-index: 999;
}

.fab {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border: none;
  font-size: 28px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.fab::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255,255,255,0.3);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.fab:active::before {
  width: 300px;
  height: 300px;
}

.fab:active {
  transform: scale(0.9) rotate(90deg);
}

.fab.open {
  transform: rotate(45deg);
}

.speed-dial-actions {
  position: absolute;
  bottom: 70px;
  right: 0;
  display: flex;
  flex-direction: column;
  gap: 12px;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s;
}

.speed-dial.open .speed-dial-actions {
  opacity: 1;
  pointer-events: all;
  animation: slideUp 0.3s;
}

@keyframes slideUp {
  from {
    transform: translateY(20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.speed-dial-action {
  display: flex;
  align-items: center;
  gap: 12px;
  animation: slideInRight 0.3s backwards;
}

.speed-dial-action:nth-child(1) { animation-delay: 0.05s; }
.speed-dial-action:nth-child(2) { animation-delay: 0.1s; }
.speed-dial-action:nth-child(3) { animation-delay: 0.15s; }
.speed-dial-action:nth-child(4) { animation-delay: 0.2s; }
.speed-dial-action:nth-child(5) { animation-delay: 0.25s; }

@keyframes slideInRight {
  from {
    transform: translateX(100px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.speed-dial-label {
  background: var(--card);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  white-space: nowrap;
}

.speed-dial-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--card);
  color: var(--primary);
  border: none;
  font-size: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  cursor: pointer;
  transition: all 0.2s;
}

.speed-dial-btn:active {
  transform: scale(0.9);
}

/* Quick Stats with Animation */
.quick-stats {
  display: flex;
  gap: 8px;
  padding: 12px 16px;
  background: var(--bg);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  animation: fadeIn 0.5s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.quick-stats::-webkit-scrollbar {
  display: none;
}

.quick-stat {
  background: var(--card);
  padding: 10px 14px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: fit-content;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.quick-stat::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.5s;
}

.quick-stat:active::before {
  left: 100%;
}

.quick-stat:active {
  transform: scale(0.95);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.quick-stat-icon {
  font-size: 24px;
  animation: float 3s infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

/* Tabs with Swipe Indicator */
.tabs {
  display: flex;
  background: var(--card);
  border-bottom: 2px solid var(--border);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  position: relative;
}

.tabs::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  width: 25%;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  border-radius: 3px 3px 0 0;
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.tabs::-webkit-scrollbar {
  display: none;
}

.tab {
  flex: 1;
  min-width: fit-content;
  padding: 14px 20px;
  background: transparent;
  border: none;
  color: var(--text-light);
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  position: relative;
  transition: all 0.3s;
}

.tab:active {
  transform: scale(0.95);
}

.tab.active {
  color: var(--primary);
}

/* Calendar with 3D Effect */
.calendar {
  background: var(--card);
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  margin-bottom: 16px;
  transition: all 0.3s;
  perspective: 1000px;
}

.calendar:active {
  transform: scale(0.98);
}

.days-header {
  display: grid;
  grid-template-columns: 80px repeat(6, 1fr);
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  position: relative;
  overflow: hidden;
}

.days-header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
  animation: shimmer 3s infinite;
}

@keyframes shimmer {
  from { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  to { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.day-cell.today .day-name,
.day-cell.today .day-date {
  color: #fbbf24;
  text-shadow: 0 0 10px #fbbf24, 0 0 20px #fbbf24;
  animation: glow-text 2s infinite;
}

@keyframes glow-text {
  0%, 100% { text-shadow: 0 0 10px #fbbf24; }
  50% { text-shadow: 0 0 20px #fbbf24, 0 0 30px #fbbf24; }
}

.employee-row {
  display: grid;
  grid-template-columns: 80px repeat(6, 1fr);
  border-bottom: 1px solid var(--border);
  min-height: 60px;
  transition: background 0.3s;
}

.employee-row:hover {
  background: rgba(0,172,193,0.05);
}

.day-entries {
  padding: 8px 4px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  border-right: 1px solid var(--border);
  position: relative;
  cursor: pointer;
  transition: all 0.2s;
}

.day-entries:active {
  background: rgba(0,172,193,0.1);
}

.day-entries.today {
  background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(239,68,68,0.15));
  outline: 2px solid #fbbf24;
  outline-offset: -2px;
  animation: pulse-border 2s infinite;
}

@keyframes pulse-border {
  0%, 100% {
    outline-color: #fbbf24;
    box-shadow: 0 0 10px rgba(251,191,36,0.3);
  }
  50% {
    outline-color: #fbbf24;
    box-shadow: 0 0 20px rgba(251,191,36,0.5);
  }
}

.day-entries.today::before {
  content: 'HEUTE';
  position: absolute;
  top: 2px;
  right: 2px;
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: #000;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 8px;
  font-weight: 900;
  z-index: 5;
  animation: wiggle 1s infinite;
}

.entry {
  padding: 7px 9px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 900;
  text-align: center;
  line-height: 1.2;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  border: 2px solid rgba(0,0,0,0.1);
  position: relative;
  transition: all 0.3s;
  cursor: pointer;
  overflow: hidden;
}

.entry::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255,255,255,0.5);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.entry:active::before {
  width: 200px;
  height: 200px;
}

.entry:active {
  transform: scale(0.95) rotate(2deg);
}

/* Stats with Charts */
.stat-card {
  background: var(--card);
  padding: 18px;
  border-radius: 20px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, rgba(255,255,255,0.1), transparent);
  opacity: 0;
  transition: opacity 0.3s;
}

.stat-card:active::before {
  opacity: 1;
}

.stat-card:active {
  transform: scale(0.98) translateY(-2px);
  box-shadow: 0 6px 24px rgba(0,0,0,0.15);
}

.stat-card-value {
  font-size: 36px;
  font-weight: 900;
  color: var(--text);
  margin-bottom: 4px;
  animation: countUp 1s;
}

@keyframes countUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Notifications Panel */
.notification-panel {
  position: fixed;
  top: calc(var(--safe-top) + 60px);
  right: -100%;
  width: 90%;
  max-width: 400px;
  height: calc(100% - var(--safe-top) - var(--safe-bottom) - 60px);
  background: var(--card);
  box-shadow: -4px 0 20px rgba(0,0,0,0.2);
  z-index: 999;
  transition: right 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  overflow-y: auto;
}

.notification-panel.open {
  right: 0;
}

.notification-header {
  padding: 20px;
  border-bottom: 2px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--card);
  z-index: 10;
}

.notification-item {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.2s;
  animation: slideInRight 0.3s;
}

.notification-item:active {
  background: var(--bg);
  transform: scale(0.98);
}

.notification-item.unread {
  background: rgba(0,172,193,0.05);
  border-left: 4px solid var(--primary);
}

/* Toast with Icons */
.toast {
  position: fixed;
  bottom: calc(80px + var(--safe-bottom));
  left: 50%;
  transform: translateX(-50%) translateY(200px);
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  padding: 16px 24px;
  border-radius: 50px;
  font-weight: 700;
  font-size: 14px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 12px;
  max-width: 90%;
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

.toast-icon {
  font-size: 24px;
  animation: bounce 1s infinite;
}

/* Confetti Effect */
.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  background: var(--primary);
  animation: confetti-fall 3s linear forwards;
  pointer-events: none;
  z-index: 9999;
}

@keyframes confetti-fall {
  to {
    transform: translateY(100vh) rotate(360deg);
    opacity: 0;
  }
}

/* Loading Skeleton */
.skeleton {
  background: linear-gradient(90deg, var(--border) 25%, var(--bg) 50%, var(--border) 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  border-radius: 8px;
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Camera Overlay */
.camera-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #000;
  z-index: 9999;
  display: none;
  flex-direction: column;
}

.camera-overlay.active {
  display: flex;
}

.camera-video {
  flex: 1;
  width: 100%;
  object-fit: cover;
}

.camera-controls {
  padding: 20px;
  display: flex;
  justify-content: center;
  gap: 20px;
  background: rgba(0,0,0,0.8);
}

.camera-btn {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: white;
  border: 4px solid var(--primary);
  font-size: 24px;
  cursor: pointer;
  transition: all 0.2s;
}

.camera-btn:active {
  transform: scale(0.9);
}

/* Voice Command Indicator */
.voice-indicator {
  position: fixed;
  bottom: calc(100px + var(--safe-bottom));
  left: 50%;
  transform: translateX(-50%) scale(0);
  width: 100px;
  height: 100px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 40px;
  box-shadow: 0 0 0 0 rgba(0,172,193,0.7);
  transition: transform 0.3s;
  z-index: 1000;
}

.voice-indicator.active {
  transform: translateX(-50%) scale(1);
  animation: pulse-ring 1.5s infinite;
}

@keyframes pulse-ring {
  0% {
    box-shadow: 0 0 0 0 rgba(0,172,193,0.7);
  }
  70% {
    box-shadow: 0 0 0 30px rgba(0,172,193,0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(0,172,193,0);
  }
}

/* Achievement Popup */
.achievement {
  position: fixed;
  top: calc(var(--safe-top) + 20px);
  right: -100%;
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: #000;
  padding: 16px 20px;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 700;
  z-index: 1001;
  transition: right 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  max-width: 80%;
}

.achievement.show {
  right: 20px;
}

.achievement-icon {
  font-size: 32px;
  animation: rotate 2s infinite;
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Progress Bar */
.progress-bar {
  position: fixed;
  top: calc(var(--safe-top));
  left: 0;
  right: 0;
  height: 3px;
  background: var(--border);
  z-index: 101;
  opacity: 0;
  transition: opacity 0.3s;
}

.progress-bar.active {
  opacity: 1;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--secondary), var(--primary));
  background-size: 200% 100%;
  animation: progress 2s infinite;
  width: 0%;
  transition: width 0.3s;
}

@keyframes progress {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Share Sheet */
.share-sheet {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card);
  border-radius: 24px 24px 0 0;
  padding: 24px;
  padding-bottom: calc(24px + var(--safe-bottom));
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  z-index: 1002;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
}

.share-sheet.active {
  transform: translateY(0);
}

.share-options {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-top: 20px;
}

.share-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.share-option:active {
  transform: scale(0.9);
}

.share-option-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
}

.share-option-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-light);
}
</style>
</head>
<body>

<!-- Splash Screen -->
<div class="splash">
  <div class="splash-logo">üìÖ</div>
  <div class="splash-text">Daer Dienstplan Pro</div>
</div>

<!-- Progress Bar -->
<div class="progress-bar" id="progressBar">
  <div class="progress-bar-fill" id="progressBarFill"></div>
</div>

<div class="app">
  
  <!-- Header (wie vorher, aber mit Online-Indicator) -->
  <div class="header">
    <div class="header-top">
      <div class="header-title">
        <h1>Daer Dienstplan Pro</h1>
        <div class="header-info">
          <span class="clock" id="clock">--:--</span>
          <span class="online-indicator"></span>
          <span id="weather">-</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="icon-btn" id="cameraBtn" title="QR Scanner">üì∑</button>
        <button class="icon-btn" id="voiceBtn" title="Sprachbefehle">üé§</button>
        <button class="icon-btn" id="notificationBtn" title="Benachrichtigungen">
          üîî
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <button class="icon-btn" id="themeBtn" title="Theme">üåì</button>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats" id="quickStats"></div>

    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="calendar">üìÖ Kalender</button>
      <button class="tab" data-tab="stats">üìä Statistik</button>
      <button class="tab" data-tab="timeline">‚è±Ô∏è Timeline</button>
      <button class="tab" data-tab="team">üë• Team</button>
    </div>

    <!-- Week Selector -->
    <div class="week-selector" id="weekSelector" style="display:flex; padding:12px 16px; background:var(--card); justify-content:space-between; align-items:center; border-bottom:1px solid var(--border)">
      <button class="nav-btn" id="prevWeek" style="background:var(--bg); border:none; width:44px; height:44px; border-radius:12px; font-size:20px; cursor:pointer; font-weight:700">‚Üê</button>
      <div style="text-align:center; flex:1">
        <div id="weekNumber" style="font-size:18px; font-weight:900; color:var(--primary)">Woche 1</div>
        <div id="weekDate" style="font-size:12px; color:var(--text-light); font-weight:600; margin-top:2px">-</div>
      </div>
      <button class="nav-btn" id="nextWeek" style="background:var(--bg); border:none; width:44px; height:44px; border-radius:12px; font-size:20px; cursor:pointer; font-weight:700">‚Üí</button>
    </div>

    <!-- Mitarbeiter Filter -->
    <div style="padding:10px 16px; background:var(--bg); border-bottom:1px solid var(--border)">
      <select id="employeeFilter" style="
        width:100%;
        padding:12px;
        border-radius:12px;
        border:2px solid var(--border);
        font-weight:800;
        font-size:14px;
        background:var(--card);
        color:var(--text);
        outline:none;
      ">
        <option value="all">üë• Alle Mitarbeiter</option>
      </select>
    </div>
  </div>

  <!-- Content -->
  <div class="content" id="content" style="flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch">
    
    <!-- Calendar Tab -->
    <div id="tab-calendar" class="tab-content active" style="padding:16px">
      <div class="calendar" id="calendar">
        <div class="loading" style="padding:60px 20px; text-align:center">
          <div class="spinner" style="width:48px; height:48px; border:4px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin 0.8s linear infinite; margin:0 auto 16px"></div>
          <div style="font-size:14px; font-weight:600; color:var(--text-light)">Lade Dienstplan...</div>
        </div>
      </div>
    </div>

    <!-- Stats Tab -->
    <div id="tab-stats" class="tab-content" style="padding:16px; display:none">
      <div id="statsContent"></div>
    </div>

    <!-- Timeline Tab -->
    <div id="tab-timeline" class="tab-content" style="padding:16px; display:none">
      <div id="timelineContent"></div>
    </div>

    <!-- Team Tab -->
    <div id="tab-team" class="tab-content" style="padding:16px; display:none">
      <div id="teamContent"></div>
    </div>

  </div>

</div>

<!-- Speed Dial FAB -->
<div class="speed-dial" id="speedDial">
  <div class="speed-dial-actions">
    <div class="speed-dial-action">
      <span class="speed-dial-label">Aktualisieren</span>
      <button class="speed-dial-btn" onclick="location.reload()">üîÑ</button>
    </div>
    <div class="speed-dial-action">
      <span class="speed-dial-label">Exportieren</span>
      <button class="speed-dial-btn" id="exportBtn">üì•</button>
    </div>
    <div class="speed-dial-action">
      <span class="speed-dial-label">Teilen</span>
      <button class="speed-dial-btn" id="shareBtn2">üì§</button>
    </div>
    <div class="speed-dial-action">
      <span class="speed-dial-label">Drucken</span>
      <button class="speed-dial-btn" onclick="window.print()">üñ®Ô∏è</button>
    </div>
    <div class="speed-dial-action">
      <span class="speed-dial-label">Hilfe</span>
      <button class="speed-dial-btn" id="helpBtn">‚ùì</button>
    </div>
  </div>
  <button class="fab" id="fab">+</button>
</div>

<!-- Notification Panel -->
<div class="notification-panel" id="notificationPanel">
  <div class="notification-header">
    <h3 style="font-size:18px; font-weight:900">Benachrichtigungen</h3>
    <button style="background:none; border:none; font-size:24px; cursor:pointer" onclick="document.getElementById('notificationPanel').classList.remove('open')">√ó</button>
  </div>
  <div id="notificationList">
    <div class="notification-item unread">
      <div style="font-size:14px; font-weight:700; margin-bottom:4px">üéâ Willkommen!</div>
      <div style="font-size:13px; color:var(--text-light)">Viel Spa√ü mit der neuen App!</div>
      <div style="font-size:11px; color:var(--text-light); margin-top:4px">vor 2 Min</div>
    </div>
  </div>
</div>

<!-- Camera Overlay -->
<div class="camera-overlay" id="cameraOverlay">
  <video class="camera-video" id="cameraVideo" autoplay playsinline></video>
  <div class="camera-controls">
    <button class="camera-btn" id="cameraCancelBtn">√ó</button>
    <button class="camera-btn" id="cameraCaptureBtn">üì∑</button>
  </div>
</div>

<!-- Voice Indicator -->
<div class="voice-indicator" id="voiceIndicator">üé§</div>

<!-- Toast -->
<div class="toast" id="toast">
  <span class="toast-icon" id="toastIcon">‚ÑπÔ∏è</span>
  <span id="toastText"></span>
</div>

<!-- Achievement -->
<div class="achievement" id="achievement">
  <span class="achievement-icon">üèÜ</span>
  <span id="achievementText"></span>
</div>

<!-- Share Sheet -->
<div class="share-sheet" id="shareSheet">
  <h3 style="font-size:18px; font-weight:900; margin-bottom:8px">Teilen</h3>
  <div style="font-size:13px; color:var(--text-light); margin-bottom:20px">W√§hle eine Option</div>
  <div class="share-options">
    <div class="share-option" onclick="shareVia('whatsapp')">
      <div class="share-option-icon" style="background:#25d366; color:white">üí¨</div>
      <div class="share-option-label">WhatsApp</div>
    </div>
    <div class="share-option" onclick="shareVia('email')">
      <div class="share-option-icon" style="background:#ea4335; color:white">üìß</div>
      <div class="share-option-label">E-Mail</div>
    </div>
    <div class="share-option" onclick="shareVia('copy')">
      <div class="share-option-icon" style="background:var(--primary); color:white">üìã</div>
      <div class="share-option-label">Link</div>
    </div>
    <div class="share-option" onclick="shareVia('pdf')">
      <div class="share-option-icon" style="background:#ff6b6b; color:white">üìÑ</div>
      <div class="share-option-label">PDF</div>
    </div>
  </div>
</div>

<script type="module">
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDgjZr2yrOrbl2dUoY26fl8EenOL0Hh-H4",
  authDomain: "daer-b525e.firebaseapp.com",
  databaseURL: "https://daer-b525e-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "daer-b525e",
  storageBucket: "daer-b525e.firebasestorage.app",
  messagingSenderId: "992532370590",
  appId: "1:992532370590:web:185d52a3dc6338b3ee978f"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const planRef = ref(db, "dienstplan");

const $ = id => document.getElementById(id);
let planData = null;
let currentWeek = 0;
let selectedEmployee = 'all';

// Haptic Feedback
function vibrate(duration = 10) {
  if (navigator.vibrate) navigator.vibrate(duration);
}

// Toast
function showToast(icon, text) {
  vibrate(10);
  $('toastIcon').textContent = icon;
  $('toastText').textContent = text;
  $('toast').classList.add('show');
  setTimeout(() => $('toast').classList.remove('show'), 3000);
}

// Achievement
function showAchievement(text) {
  vibrate([100, 50, 100]);
  $('achievementText').textContent = text;
  $('achievement').classList.add('show');
  throwConfetti();
  setTimeout(() => $('achievement').classList.remove('show'), 4000);
}

// Confetti
function throwConfetti() {
  for (let i = 0; i < 30; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.background = ['#00acc1', '#8b5cf6', '#f59e0b', '#ef4444', '#10b981'][Math.floor(Math.random() * 5)];
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    document.body.appendChild(confetti);
    setTimeout(() => confetti.remove(), 3000);
  }
}

// Theme mit Auto-Dark-Mode
let themeMode = localStorage.getItem('theme-mode') || 'auto';
function applyTheme() {
  document.body.classList.remove('dark', 'auto-dark');
  if (themeMode === 'dark') {
    document.body.classList.add('dark');
  } else if (themeMode === 'auto') {
    const hour = new Date().getHours();
    if (hour < 7 || hour >= 20) {
      document.body.classList.add('auto-dark');
    }
  }
}

$('themeBtn').onclick = () => {
  vibrate(10);
  themeMode = themeMode === 'light' ? 'dark' : themeMode === 'dark' ? 'auto' : 'light';
  localStorage.setItem('theme-mode', themeMode);
  applyTheme();
  showToast('üé®', `Theme: ${themeMode === 'auto' ? 'Automatisch' : themeMode === 'dark' ? 'Dunkel' : 'Hell'}`);
};
applyTheme();
setInterval(applyTheme, 60000); // Check every minute

// Clock
function updateClock() {
  $('clock').textContent = new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
}
setInterval(updateClock, 1000);
updateClock();

// Wetter (Open-Meteo, ohne API-Key)
async function loadWeather() {
  const el = $('weather');
  if (!el) return;
  try {
    // Default: Hennigsdorf
    const lat = 52.64;
    const lon = 13.21;

    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
    const data = await res.json();
    if (data?.current_weather) {
      const t = Math.round(data.current_weather.temperature);
      const w = Math.round(data.current_weather.windspeed);
      el.textContent = `üå§ ${t}¬∞C | üí® ${w} km/h`;
    } else {
      el.textContent = 'Wetter -';
    }
  } catch (e) {
    el.textContent = 'Wetter offline';
  }
}
loadWeather();
setInterval(loadWeather, 10 * 60 * 1000);

// Speed Dial FAB
$('fab').onclick = () => {
  vibrate(15);
  $('speedDial').classList.toggle('open');
  $('fab').classList.toggle('open');
};

// Camera
$('cameraBtn').onclick = async () => {
  vibrate(10);
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    $('cameraVideo').srcObject = stream;
    $('cameraOverlay').classList.add('active');
    showToast('üì∑', 'QR-Code scannen');
  } catch(e) {
    showToast('‚ùå', 'Kamera-Zugriff verweigert');
  }
};

$('cameraCancelBtn').onclick = () => {
  $('cameraVideo').srcObject?.getTracks().forEach(t => t.stop());
  $('cameraOverlay').classList.remove('active');
};

$('cameraCaptureBtn').onclick = () => {
  vibrate([50, 100, 50]);
  showToast('‚úÖ', 'Foto aufgenommen!');
  showAchievement('üì∏ Erstes Foto!');
};

// Voice Commands
let recognition;
if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'de-DE';
  recognition.continuous = false;
  
  recognition.onstart = () => {
    $('voiceIndicator').classList.add('active');
    vibrate([50, 100]);
  };
  
  recognition.onend = () => {
    $('voiceIndicator').classList.remove('active');
  };
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript.toLowerCase();
    showToast('üé§', `"${transcript}"`);
    
    if (transcript.includes('n√§chste woche')) {
      if (currentWeek < 3) {
        currentWeek++;
        render();
        vibrate(10);
      }
    } else if (transcript.includes('vorherige woche')) {
      if (currentWeek > 0) {
        currentWeek--;
        render();
        vibrate(10);
      }
    } else if (transcript.includes('aktualisieren')) {
      location.reload();
    } else if (transcript.includes('teilen')) {
      $('shareSheet').classList.add('active');
      vibrate(10);
    }
  };
}

$('voiceBtn').onclick = () => {
  vibrate(10);
  if (recognition) {
    recognition.start();
  } else {
    showToast('‚ùå', 'Spracherkennung nicht verf√ºgbar');
  }
};

// Notifications
// Notifications Management
let notifications = [];

$('notificationBtn').onclick = () => {
  vibrate(10);
  $('notificationPanel').classList.toggle('open');
  $('notifBadge').style.display = 'none';
  renderNotifications();
};

function renderNotifications() {
  const list = document.getElementById('notificationList');
  if (!list) return;
  
  list.innerHTML = `
    <div style="padding:16px; background:var(--bg); margin-bottom:8px; border-radius:12px; cursor:pointer" onclick="openNewNotificationDialog()">
      <div style="display:flex; align-items:center; gap:12px">
        <div style="width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg, var(--primary), var(--secondary)); display:flex; align-items:center; justify-content:center; font-size:20px; color:white">+</div>
        <div style="flex:1">
          <div style="font-size:14px; font-weight:800; color:var(--text)">Neue Nachricht erstellen</div>
          <div style="font-size:12px; color:var(--text-light); margin-top:2px">Wird auf dem TV-Display angezeigt</div>
        </div>
      </div>
    </div>
  ` + notifications.map((notif, idx) => {
    const icons = {info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è', urgent: 'üö®', success: '‚úÖ', event: 'üìÖ'};
    const colors = {info: '#3b82f6', warning: '#f59e0b', urgent: '#ef4444', success: '#10b981', event: '#8b5cf6'};
    
    return `
      <div class="notification-item" style="position:relative">
        <div style="display:flex; gap:12px; align-items:start">
          <div style="font-size:28px">${icons[notif.type] || '‚ÑπÔ∏è'}</div>
          <div style="flex:1">
            <div style="font-size:14px; font-weight:800; color:var(--text); margin-bottom:4px">${esc(notif.title)}</div>
            <div style="font-size:13px; color:var(--text-light); line-height:1.4">${esc(notif.message)}</div>
            <div style="font-size:11px; color:var(--text-light); margin-top:6px; display:flex; gap:12px">
              <span>üìÖ ${formatDateFull(notif.createdAt)}</span>
              ${notif.expiresAt ? `<span>‚è∞ Bis ${formatDateFull(notif.expiresAt)}</span>` : ''}
            </div>
          </div>
          <button onclick="deleteNotification(${idx}); event.stopPropagation()" style="background:#ef4444; border:none; color:white; width:32px; height:32px; border-radius:50%; font-size:16px; font-weight:900; cursor:pointer">√ó</button>
        </div>
      </div>
    `;
  }).join('');
  
  if (notifications.length === 0) {
    list.innerHTML += `
      <div style="text-align:center; padding:40px 20px">
        <div style="font-size:48px; opacity:0.3; margin-bottom:12px">üîî</div>
        <div style="font-size:14px; font-weight:700; color:var(--text-light)">Keine Benachrichtigungen</div>
        <div style="font-size:12px; color:var(--text-light); margin-top:4px">Erstelle eine neue Nachricht f√ºr das TV-Display</div>
      </div>
    `;
  }
}

function openNewNotificationDialog() {
  vibrate(10);
  
  const html = `
    <div style="margin-top:20px">
      <label style="display:block; margin-bottom:8px; font-size:13px; font-weight:700; color:var(--text-light)">Typ</label>
      <select id="notifType" style="width:100%; padding:12px; border-radius:10px; border:2px solid var(--border); background:var(--bg); color:var(--text); font-size:14px; font-weight:600; margin-bottom:16px">
        <option value="info">‚ÑπÔ∏è Info</option>
        <option value="warning">‚ö†Ô∏è Warnung</option>
        <option value="urgent">üö® Dringend</option>
        <option value="success">‚úÖ Erfolg</option>
        <option value="event">üìÖ Event</option>
      </select>
      
      <label style="display:block; margin-bottom:8px; font-size:13px; font-weight:700; color:var(--text-light)">Titel</label>
      <input id="notifTitle" type="text" placeholder="z.B. Wichtige Mitteilung" style="width:100%; padding:12px; border-radius:10px; border:2px solid var(--border); background:var(--bg); color:var(--text); font-size:14px; font-weight:600; margin-bottom:16px">
      
      <label style="display:block; margin-bottom:8px; font-size:13px; font-weight:700; color:var(--text-light)">Nachricht</label>
      <textarea id="notifMessage" placeholder="Deine Nachricht..." rows="4" style="width:100%; padding:12px; border-radius:10px; border:2px solid var(--border); background:var(--bg); color:var(--text); font-size:14px; font-weight:600; margin-bottom:16px; resize:vertical"></textarea>
      
      <label style="display:block; margin-bottom:8px; font-size:13px; font-weight:700; color:var(--text-light)">
        <input type="checkbox" id="notifExpires" style="margin-right:8px">
        Automatisch l√∂schen nach
      </label>
      <select id="notifExpireDays" disabled style="width:100%; padding:12px; border-radius:10px; border:2px solid var(--border); background:var(--bg); color:var(--text); font-size:14px; font-weight:600; margin-bottom:20px">
        <option value="1">1 Tag</option>
        <option value="3">3 Tage</option>
        <option value="7" selected>7 Tage</option>
        <option value="14">14 Tage</option>
        <option value="30">30 Tage</option>
      </select>
      
      <button onclick="createNotification()" style="width:100%; padding:16px; background:linear-gradient(135deg, var(--primary), var(--secondary)); color:white; border:none; border-radius:12px; font-size:16px; font-weight:900; cursor:pointer">
        Erstellen & auf TV anzeigen
      </button>
    </div>
  `;
  
  showModal('üîî Neue Nachricht', html);
  
  setTimeout(() => {
    document.getElementById('notifExpires').onchange = (e) => {
      document.getElementById('notifExpireDays').disabled = !e.target.checked;
    };
  }, 100);
}

async function createNotification() {
  const type = document.getElementById('notifType').value;
  const title = document.getElementById('notifTitle').value.trim();
  const message = document.getElementById('notifMessage').value.trim();
  const expires = document.getElementById('notifExpires').checked;
  const days = parseInt(document.getElementById('notifExpireDays').value);
  
  if (!title || !message) {
    showToast('‚ùå', 'Bitte Titel und Nachricht eingeben');
    return;
  }
  
  const now = new Date();
  const expiresAt = expires ? new Date(now.getTime() + days * 24 * 60 * 60 * 1000).toISOString() : null;
  
  const notif = {
    type,
    title,
    message,
    createdAt: now.toISOString(),
    expiresAt,
    createdBy: 'Mobile App',
    id: Date.now()
  };
  
  notifications.push(notif);
  
  // Save to Firebase
  try {
    const { set } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js');
    const notifRef = ref(db, 'notifications');
    await set(notifRef, notifications);
    
    vibrate([50, 100, 50]);
    showToast('‚úÖ', 'Nachricht erstellt!');
    showAchievement('üì¢ Erste Nachricht erstellt!');
    
    $('modal').classList.remove('active');
    $('notificationPanel').classList.remove('open');
    
    updateNotificationBadge();
  } catch(e) {
    showToast('‚ùå', 'Fehler beim Speichern');
  }
}

async function deleteNotification(idx) {
  vibrate(10);
  
  if (!confirm('Nachricht wirklich l√∂schen?')) return;
  
  notifications.splice(idx, 1);
  
  try {
    const { set } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js');
    const notifRef = ref(db, 'notifications');
    await set(notifRef, notifications);
    
    vibrate(50);
    showToast('üóëÔ∏è', 'Nachricht gel√∂scht');
    renderNotifications();
    updateNotificationBadge();
  } catch(e) {
    showToast('‚ùå', 'Fehler beim L√∂schen');
  }
}

function updateNotificationBadge() {
  const activeNotifs = notifications.filter(n => {
    if (!n.expiresAt) return true;
    return new Date(n.expiresAt) > new Date();
  });
  
  const badge = $('notifBadge');
  if (activeNotifs.length > 0) {
    badge.textContent = activeNotifs.length;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

// Load notifications from Firebase
async function loadNotificationsData() {
  try {
    onValue(ref(db, 'notifications'), (snap) => {
      if (snap.exists()) {
        notifications = snap.val() || [];
        
        // Auto-delete expired
        const now = new Date();
        const filtered = notifications.filter(n => {
          if (!n.expiresAt) return true;
          return new Date(n.expiresAt) > now;
        });
        
        if (filtered.length !== notifications.length) {
          notifications = filtered;
          const { set } = import('https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js');
          set(ref(db, 'notifications'), notifications);
        }
        
        updateNotificationBadge();
        renderNotifications();
      }
    });
  } catch(e) {
    console.error('Notifications load error:', e);
  }
}

// Initialize
loadNotificationsData();

// Share
function shareVia(method) {
  vibrate(10);
  $('shareSheet').classList.remove('active');
  
  if (method === 'whatsapp') {
    window.open(`https://wa.me/?text=Schau dir meinen Dienstplan an: ${window.location.href}`);
  } else if (method === 'email') {
    window.location.href = `mailto:?subject=Dienstplan&body=${window.location.href}`;
  } else if (method === 'copy') {
    navigator.clipboard.writeText(window.location.href);
    showToast('üìã', 'Link kopiert!');
  } else if (method === 'pdf') {
    showToast('üìÑ', 'PDF wird erstellt...');
    setTimeout(() => window.print(), 500);
  }
}

$('shareBtn2').onclick = () => {
  vibrate(10);
  $('shareSheet').classList.add('active');
  $('speedDial').classList.remove('open');
  $('fab').classList.remove('open');
};

// Export
$('exportBtn').onclick = () => {
  vibrate(10);
  showToast('üì•', 'Export wird vorbereitet...');
  
  const csv = 'Mitarbeiter,Montag,Dienstag,Mittwoch,Donnerstag,Freitag,Samstag\n';
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `dienstplan-woche-${currentWeek + 1}.csv`;
  a.click();
  
  showAchievement('üì• Erster Export!');
  $('speedDial').classList.remove('open');
  $('fab').classList.remove('open');
};

// Help
$('helpBtn').onclick = () => {
  vibrate(10);
  showToast('‚ùì', 'Hilfe: Swipe f√ºr Wochen, üé§ f√ºr Sprache, üì∑ f√ºr QR-Scan');
  $('speedDial').classList.remove('open');
  $('fab').classList.remove('open');
};

// Shake to Refresh
let lastShake = 0;
if (window.DeviceMotionEvent) {
  window.addEventListener('devicemotion', (e) => {
    const acc = e.accelerationIncludingGravity;
    const threshold = 15;
    
    if (Math.abs(acc.x) > threshold || Math.abs(acc.y) > threshold || Math.abs(acc.z) > threshold) {
      const now = Date.now();
      if (now - lastShake > 1000) {
        lastShake = now;
        vibrate([100, 50, 100, 50, 100]);
        showToast('üîÑ', 'Aktualisiere...');
        setTimeout(() => location.reload(), 500);
      }
    }
  });
}

// Render Functions
const todayISO = () => {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
};

const addDays = (iso, days) => {
  const d = new Date(iso);
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0, 10);
};

const formatDate = iso => {
  const d = new Date(iso);
  return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.`;
};

const formatDateFull = iso => {
  const d = new Date(iso);
  return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
};

const diffDays = (a, b) => Math.floor((new Date(b) - new Date(a)) / (1000*60*60*24));

const isDark = hex => {
  if (!hex || hex[0] !== '#') return false;
  const r = parseInt(hex.slice(1,3), 16);
  const g = parseInt(hex.slice(3,5), 16);
  const b = parseInt(hex.slice(5,7), 16);
  return (0.2126*r + 0.7152*g + 0.0722*b) / 255 < 0.6;
};

const esc = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function populateEmployeeFilter() {
  const select = $('employeeFilter');
  if (!select) return;

  // Keep current selection if possible
  const prev = selectedEmployee;
  select.innerHTML = '<option value="all">üë• Alle Mitarbeiter</option>';

  (planData?.employees || []).forEach((emp, index) => {
    const opt = document.createElement('option');
    opt.value = String(index);
    opt.textContent = emp?.name ? emp.name : `Mitarbeiter ${index+1}`;
    select.appendChild(opt);
  });

  // Restore selection if still valid
  if (prev === 'all') {
    select.value = 'all';
    selectedEmployee = 'all';
  } else {
    const idx = parseInt(prev, 10);
    if (!Number.isNaN(idx) && idx >= 0 && idx < (planData?.employees || []).length) {
      select.value = String(idx);
      selectedEmployee = String(idx);
    } else {
      select.value = 'all';
      selectedEmployee = 'all';
    }
  }
}

(function bindEmployeeFilter() {
  const select = $('employeeFilter');
  if (!select) return;
  select.addEventListener('change', (e) => {
    selectedEmployee = e.target.value;
    vibrate(10);
    render();
  });
})();


function findCurrentWeek(startDate) {
  const age = diffDays(startDate, todayISO());
  return (age >= 0 && age < 28) ? Math.floor(age / 7) : 0;
}

function render() {
  if (!planData) return;
  
  const weekStart = addDays(planData.start, currentWeek * 7);
  const weekEnd = addDays(weekStart, 5);
  
  $('weekNumber').textContent = `Woche ${currentWeek + 1}`;
  $('weekDate').textContent = `${formatDateFull(weekStart)} - ${formatDateFull(weekEnd)}`;
  
  const age = diffDays(planData.start, todayISO());
  const todayWeek = (age >= 0 && age < 28) ? Math.floor(age / 7) : -1;
  const todayDay = (age >= 0 && age < 28) ? age % 7 : -1;
  
  const templates = new Map((planData.templates || []).map(t => [t.name, t]));
  const days = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
  const employees = planData.employees || [];
  
  const stats = {einsatz: 0, urlaub: 0, krank: 0, frei: 0};
  
  const cal = $('calendar');
  cal.innerHTML = '';
  
  // Days Header
  const daysHeader = document.createElement('div');
  daysHeader.className = 'days-header';
  daysHeader.innerHTML = '<div class="day-cell" style="padding:12px 4px; text-align:center; border-right:1px solid rgba(255,255,255,0.2)"><div style="font-size:12px">MA</div></div>';
  
  days.forEach((day, idx) => {
    const isToday = currentWeek === todayWeek && idx === todayDay;
    const dateStr = formatDate(addDays(weekStart, idx));
    daysHeader.innerHTML += `
      <div class="day-cell ${isToday ? 'today' : ''}" style="padding:12px 4px; text-align:center; border-right:1px solid rgba(255,255,255,0.2)">
        <div class="day-name" style="font-size:14px; font-weight:900; margin-bottom:2px">${day}</div>
        <div class="day-date" style="font-size:11px; font-weight:600; opacity:0.9">${dateStr}</div>
      </div>
    `;
  });
  
  daysHeader.lastElementChild.style.borderRight = 'none';
  cal.appendChild(daysHeader);
  
  // Employee Rows
  employees.forEach((emp, r) => {
    if (selectedEmployee !== 'all' && String(r) !== String(selectedEmployee)) return;
    const row = document.createElement('div');
    row.className = 'employee-row';
    
    row.innerHTML = `
      <div class="employee-name" style="display:flex; align-items:center; gap:8px; padding:12px 8px; background:var(--bg); border-right:1px solid var(--border); position:sticky; left:0; z-index:10; cursor:pointer">
        <span style="width:14px; height:14px; border-radius:50%; border:3px solid currentColor; flex-shrink:0; background:${emp.color}"></span>
        <span style="font-size:13px; font-weight:800; line-height:1.2">${esc(emp.name)}</span>
      </div>
    `;
    
    for (let d = 0; d < 6; d++) {
      const isToday = currentWeek === todayWeek && d === todayDay;
      const key = `${currentWeek}-${r}-${d}`;
      const items = planData.assignments?.[key] || [];
      
      const dayDiv = document.createElement('div');
      dayDiv.className = `day-entries ${isToday ? 'today' : ''}`;
      
      items.forEach(name => {
        const tpl = templates.get(name) || {name, type: 'einsatz', color: emp.color};
        const entry = document.createElement('div');
        entry.className = 'entry';
        entry.style.background = tpl.color;
        entry.style.color = isDark(tpl.color) ? '#fff' : '#000';
        entry.textContent = name;
        
        entry.onclick = () => {
          vibrate(10);
          showToast('üìå', `${emp.name}: ${name} am ${formatDateFull(addDays(weekStart, d))}`);
        };
        
        if (tpl.type === 'urlaub') stats.urlaub++;
        else if (tpl.type === 'krank') stats.krank++;
        else if (tpl.type === 'frei') stats.frei++;
        else stats.einsatz++;
        
        dayDiv.appendChild(entry);
      });
      
      row.appendChild(dayDiv);
    }
    
    cal.appendChild(row);
  });
  
  // Quick Stats
  $('quickStats').innerHTML = `
    <div class="quick-stat" onclick="vibrate(10)">
      <div class="quick-stat-icon">üíº</div>
      <div><div style="font-size:11px; color:var(--text-light); font-weight:600">Einsatz</div><div style="font-size:16px; font-weight:900">${stats.einsatz}</div></div>
    </div>
    <div class="quick-stat" onclick="vibrate(10)">
      <div class="quick-stat-icon">üèñÔ∏è</div>
      <div><div style="font-size:11px; color:var(--text-light); font-weight:600">Urlaub</div><div style="font-size:16px; font-weight:900">${stats.urlaub}</div></div>
    </div>
    <div class="quick-stat" onclick="vibrate(10)">
      <div class="quick-stat-icon">ü§í</div>
      <div><div style="font-size:11px; color:var(--text-light); font-weight:600">Krank</div><div style="font-size:16px; font-weight:900">${stats.krank}</div></div>
    </div>
    <div class="quick-stat" onclick="vibrate(10)">
      <div class="quick-stat-icon">‚ú®</div>
      <div><div style="font-size:11px; color:var(--text-light); font-weight:600">Frei</div><div style="font-size:16px; font-weight:900">${stats.frei}</div></div>
    </div>
  `;
  
  $('prevWeek').disabled = currentWeek === 0;
  $('nextWeek').disabled = currentWeek === 3;
}

// Navigation
$('prevWeek').onclick = () => {
  if (currentWeek > 0) {
    vibrate(10);
    currentWeek--;
    render();
  }
};

$('nextWeek').onclick = () => {
  if (currentWeek < 3) {
    vibrate(10);
    currentWeek++;
    render();
  }
};

// Swipe Gestures
let touchStartX = 0;
const content = $('content');

content.addEventListener('touchstart', e => {
  touchStartX = e.changedTouches[0].screenX;
}, {passive: true});

content.addEventListener('touchend', e => {
  const diff = touchStartX - e.changedTouches[0].screenX;
  
  if (Math.abs(diff) > 100) {
    if (diff > 0 && currentWeek < 3) {
      currentWeek++;
      render();
      vibrate(10);
      showToast('üìÖ', `Woche ${currentWeek + 1}`);
    } else if (diff < 0 && currentWeek > 0) {
      currentWeek--;
      render();
      vibrate(10);
      showToast('üìÖ', `Woche ${currentWeek + 1}`);
    }
  }
}, {passive: true});

// Tab Switching
const tabs = document.querySelectorAll('.tab');
tabs.forEach(tab => {
  tab.onclick = () => {
    vibrate(10);
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tc => {
      tc.style.display = 'none';
    });
    
    // Show selected tab
    const tabName = tab.dataset.tab;
    const tabContent = document.getElementById(`tab-${tabName}`);
    if (tabContent) {
      tabContent.style.display = 'block';
    }
    
    // Render tab content
    if (tabName === 'stats') renderStats();
    else if (tabName === 'timeline') renderTimeline();
    else if (tabName === 'team') renderTeam();
    
    // Hide week selector for non-calendar tabs
    $('weekSelector').style.display = tabName === 'calendar' ? 'flex' : 'none';
  };
});

// Render Statistics Tab
function renderStats() {
  if (!planData) return;
  
  const templates = new Map((planData.templates || []).map(t => [t.name, t]));
  
  // Calculate stats for all weeks
  const weekStats = [0, 0, 0, 0].map((_, weekIdx) => {
    const stats = {einsatz: 0, urlaub: 0, krank: 0, frei: 0, total: 0};
    
    Object.keys(planData.assignments || {}).forEach(key => {
      const [w] = key.split('-').map(Number);
      if (w === weekIdx) {
        (planData.assignments[key] || []).forEach(name => {
          const tpl = templates.get(name);
          if (tpl?.type === 'urlaub') stats.urlaub++;
          else if (tpl?.type === 'krank') stats.krank++;
          else if (tpl?.type === 'frei') stats.frei++;
          else stats.einsatz++;
          stats.total++;
        });
      }
    });
    
    return stats;
  });
  
  // Total stats
  const totals = {einsatz: 0, urlaub: 0, krank: 0, frei: 0};
  weekStats.forEach(ws => {
    totals.einsatz += ws.einsatz;
    totals.urlaub += ws.urlaub;
    totals.krank += ws.krank;
    totals.frei += ws.frei;
  });
  const grandTotal = totals.einsatz + totals.urlaub + totals.krank + totals.frei;
  
  const statsContent = document.getElementById('statsContent');
  if (!statsContent) return;
  
  const maxTotal = Math.max(...weekStats.map(w => w.total), 1);
  
  statsContent.innerHTML = `
    <h2 style="font-size:22px; font-weight:900; margin-bottom:20px; background:linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent">üìä Statistik</h2>
    
    <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-bottom:24px">
      <div class="stat-card" style="background:linear-gradient(135deg, rgba(0,172,193,0.15), rgba(0,172,193,0.05))">
        <div style="font-size:14px; color:var(--primary); font-weight:700; margin-bottom:8px">üíº Eins√§tze</div>
        <div style="font-size:36px; font-weight:900; color:var(--primary)">${totals.einsatz}</div>
        <div style="font-size:12px; color:var(--text-light); font-weight:600">${grandTotal > 0 ? Math.round(totals.einsatz/grandTotal*100) : 0}%</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.05))">
        <div style="font-size:14px; color:#f59e0b; font-weight:700; margin-bottom:8px">üèñÔ∏è Urlaub</div>
        <div style="font-size:36px; font-weight:900; color:#f59e0b">${totals.urlaub}</div>
        <div style="font-size:12px; color:var(--text-light); font-weight:600">${grandTotal > 0 ? Math.round(totals.urlaub/grandTotal*100) : 0}%</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.05))">
        <div style="font-size:14px; color:#ef4444; font-weight:700; margin-bottom:8px">ü§í Krank</div>
        <div style="font-size:36px; font-weight:900; color:#ef4444">${totals.krank}</div>
        <div style="font-size:12px; color:var(--text-light); font-weight:600">${grandTotal > 0 ? Math.round(totals.krank/grandTotal*100) : 0}%</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg, rgba(16,185,129,0.15), rgba(16,185,129,0.05))">
        <div style="font-size:14px; color:#10b981; font-weight:700; margin-bottom:8px">‚ú® Frei</div>
        <div style="font-size:36px; font-weight:900; color:#10b981">${totals.frei}</div>
        <div style="font-size:12px; color:var(--text-light); font-weight:600">${grandTotal > 0 ? Math.round(totals.frei/grandTotal*100) : 0}%</div>
      </div>
    </div>
    
    <div class="stat-card">
      <h3 style="font-size:18px; font-weight:800; margin-bottom:20px">üìà Wochenvergleich</h3>
      <div style="display:flex; align-items:flex-end; justify-content:space-around; height:200px; gap:12px">
        ${weekStats.map((ws, i) => {
          const height = (ws.total / maxTotal) * 100;
          return `
            <div style="flex:1; display:flex; flex-direction:column; align-items:center; gap:8px; cursor:pointer" onclick="vibrate(10); currentWeek=${i}; document.querySelector('[data-tab=calendar]').click(); render()">
              <div style="font-size:16px; font-weight:900; color:var(--primary)">${ws.total}</div>
              <div style="width:100%; height:${height}%; min-height:10px; background:linear-gradient(180deg, var(--primary), var(--secondary)); border-radius:8px 8px 0 0"></div>
              <div style="font-size:13px; font-weight:700; color:var(--text-light)">W${i + 1}</div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
  
  showToast('üìä', 'Statistiken geladen!');
}

// Render Timeline Tab
function renderTimeline() {
  if (!planData) return;
  
  const templates = new Map((planData.templates || []).map(t => [t.name, t]));
  const employees = planData.employees || [];
  
  const events = [];
  Object.keys(planData.assignments || {}).forEach(key => {
    const [week, empIdx, day] = key.split('-').map(Number);
    const emp = employees[empIdx];
    if (!emp) return;
    
    const weekStart = addDays(planData.start, week * 7);
    const eventDate = addDays(weekStart, day);
    
    (planData.assignments[key] || []).forEach(name => {
      const tpl = templates.get(name);
      events.push({
        date: eventDate,
        employee: emp.name,
        type: name,
        icon: tpl?.type === 'urlaub' ? 'üèñÔ∏è' : tpl?.type === 'krank' ? 'ü§í' : tpl?.type === 'frei' ? '‚ú®' : 'üíº',
        color: tpl?.color || emp.color
      });
    });
  });
  
  events.sort((a, b) => new Date(a.date) - new Date(b.date));
  
  const timelineContent = document.getElementById('timelineContent');
  if (!timelineContent) return;
  
  timelineContent.innerHTML = `
    <h2 style="font-size:22px; font-weight:900; margin-bottom:20px; background:linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent">‚è±Ô∏è Timeline</h2>
    
    <div style="position:relative; padding-left:40px">
      ${events.length === 0 ? `
        <div style="text-align:center; padding:60px 20px">
          <div style="font-size:64px; opacity:0.3">üìÖ</div>
          <div style="font-size:16px; font-weight:700; color:var(--text-light); margin-top:16px">Noch keine Eintr√§ge</div>
        </div>
      ` : events.map((evt, i) => `
        <div style="position:relative; padding-bottom:24px">
          <div style="position:absolute; left:-40px; top:2px; width:20px; height:20px; border-radius:50%; border:4px solid ${evt.color}; background:var(--card); z-index:2"></div>
          ${i < events.length - 1 ? `<div style="position:absolute; left:-32px; top:22px; bottom:0; width:4px; background:var(--border)"></div>` : ''}
          
          <div class="stat-card" onclick="vibrate(10)">
            <div style="display:flex; justify-content:space-between; align-items:start">
              <div style="display:flex; align-items:center; gap:12px">
                <span style="font-size:24px">${evt.icon}</span>
                <div>
                  <div style="font-size:15px; font-weight:800">${evt.type}</div>
                  <div style="font-size:13px; color:var(--text-light); font-weight:600">${evt.employee}</div>
                </div>
              </div>
              <div style="text-align:right">
                <div style="font-size:13px; font-weight:700; color:${evt.color}">${formatDateFull(evt.date)}</div>
                <div style="font-size:11px; color:var(--text-light)">${['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][new Date(evt.date).getDay()]}</div>
              </div>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  
  showToast('‚è±Ô∏è', 'Timeline geladen!');
}

// Render Team Tab
function renderTeam() {
  if (!planData) return;
  
  const templates = new Map((planData.templates || []).map(t => [t.name, t]));
  const employees = planData.employees || [];
  
  const empStats = employees.map((emp, empIdx) => {
    const stats = {einsatz: 0, urlaub: 0, krank: 0, frei: 0, total: 0};
    
    Object.keys(planData.assignments || {}).forEach(key => {
      const [, r] = key.split('-').map(Number);
      if (r === empIdx) {
        (planData.assignments[key] || []).forEach(name => {
          const tpl = templates.get(name);
          if (tpl?.type === 'urlaub') stats.urlaub++;
          else if (tpl?.type === 'krank') stats.krank++;
          else if (tpl?.type === 'frei') stats.frei++;
          else stats.einsatz++;
          stats.total++;
        });
      }
    });
    
    return { ...emp, stats };
  });
  
  empStats.sort((a, b) => b.stats.total - a.stats.total);
  const maxTotal = Math.max(...empStats.map(e => e.stats.total), 1);
  
  const teamContent = document.getElementById('teamContent');
  if (!teamContent) return;
  
  teamContent.innerHTML = `
    <h2 style="font-size:22px; font-weight:900; margin-bottom:20px; background:linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent">üë• Team</h2>
    
    <div style="display:grid; gap:16px">
      ${empStats.map((emp, rank) => `
        <div class="stat-card" onclick="vibrate(10)">
          <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px">
            <div style="width:60px; height:60px; border-radius:50%; background:${emp.color}; display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:900; color:${isDark(emp.color) ? '#fff' : '#000'}; box-shadow:0 4px 12px rgba(0,0,0,0.15)">
              ${emp.name.charAt(0).toUpperCase()}
            </div>
            <div style="flex:1">
              <div style="font-size:20px; font-weight:900">${esc(emp.name)}</div>
              <div style="font-size:14px; color:var(--text-light); font-weight:600">${emp.stats.total} Eintr√§ge</div>
            </div>
            <div style="font-size:28px; font-weight:900; color:${rank === 0 ? '#fbbf24' : rank === 1 ? '#cbd5e0' : rank === 2 ? '#f59e0b' : 'var(--text-light)'}">
              ${rank + 1}
            </div>
          </div>
          
          <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-bottom:16px">
            <div style="text-align:center; padding:12px; background:rgba(0,172,193,0.1); border-radius:10px">
              <div style="font-size:24px; font-weight:900; color:var(--primary)">${emp.stats.einsatz}</div>
              <div style="font-size:11px; color:var(--text-light); font-weight:700">üíº Einsatz</div>
            </div>
            <div style="text-align:center; padding:12px; background:rgba(245,158,11,0.1); border-radius:10px">
              <div style="font-size:24px; font-weight:900; color:#f59e0b">${emp.stats.urlaub}</div>
              <div style="font-size:11px; color:var(--text-light); font-weight:700">üèñÔ∏è Urlaub</div>
            </div>
            <div style="text-align:center; padding:12px; background:rgba(239,68,68,0.1); border-radius:10px">
              <div style="font-size:24px; font-weight:900; color:#ef4444">${emp.stats.krank}</div>
              <div style="font-size:11px; color:var(--text-light); font-weight:700">ü§í Krank</div>
            </div>
            <div style="text-align:center; padding:12px; background:rgba(16,185,129,0.1); border-radius:10px">
              <div style="font-size:24px; font-weight:900; color:#10b981">${emp.stats.frei}</div>
              <div style="font-size:11px; color:var(--text-light); font-weight:700">‚ú® Frei</div>
            </div>
          </div>
          
          <div>
            <div style="display:flex; justify-content:space-between; margin-bottom:8px">
              <span style="font-size:12px; font-weight:700; color:var(--text-light)">Aktivit√§t</span>
              <span style="font-size:12px; font-weight:900; color:var(--primary)">${Math.round(emp.stats.total/maxTotal*100)}%</span>
            </div>
            <div style="height:8px; background:var(--border); border-radius:4px; overflow:hidden">
              <div style="height:100%; background:linear-gradient(90deg, ${emp.color}, var(--primary)); width:${emp.stats.total/maxTotal*100}%; border-radius:4px"></div>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
    
    ${empStats.length === 0 ? `
      <div style="text-align:center; padding:60px 20px">
        <div style="font-size:64px; opacity:0.3">üë•</div>
        <div style="font-size:16px; font-weight:700; color:var(--text-light); margin-top:16px">Noch keine Mitarbeiter</div>
      </div>
    ` : ''}
  `;
  
  showToast('üë•', 'Team-√úbersicht geladen!');
}

// Load Data
let loadCount = 0;
onValue(planRef, snap => {
  if (snap.exists()) {
    planData = snap.val();
    populateEmployeeFilter();
    currentWeek = findCurrentWeek(planData.start);
    render();
    
    loadCount++;
    if (loadCount === 1) {
      showToast('‚úÖ', 'Dienstplan geladen!');
      setTimeout(() => showAchievement('üéâ Erste Anmeldung!'), 1000);
    }
  }
});

// Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}

// Install Prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  showToast('üì±', 'App installieren? Tippe auf +');
});

window.addEventListener('appinstalled', () => {
  showAchievement('üéâ App installiert!');
  deferredPrompt = null;
});

// Long Press Easter Egg
let longPressTimer;
$('fab').addEventListener('touchstart', () => {
  longPressTimer = setTimeout(() => {
    vibrate([50, 100, 50, 100, 50]);
    throwConfetti();
    showAchievement('üéä Easter Egg gefunden!');
  }, 3000);
});

$('fab').addEventListener('touchend', () => {
  clearTimeout(longPressTimer);
});
</script>

<style>
@keyframes spin { to { transform: rotate(360deg); } }
</style>

</body>
</html>
