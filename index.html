<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Daer ‚Äì Dienstleister | TV</title>
<style>
:root{
  --emp-count:12;
  --dayhead-h:clamp(44px, 6vh, 70px);
  --bg:#0b1020;
  --card:#141c30;
  --text:#fff;
  --muted:rgba(255,255,255,.72);
  --header:#1c2842;
  --border:#2b3a55;
  --accent:#4cc9f0;
  --today:rgba(0,255,204,.9);
  --shadow:0 6px 24px rgba(0,0,0,.18);
}
body.light{
  --bg:#f0f4f8;
  --card:#ffffff;
  --text:#1a202c;
  --muted:rgba(26,32,44,.72);
  --header:#e6f7f9;
  --border:#cbd5e0;
  --accent:#00acc1;
  --today:rgba(0,172,193,.9);
  --shadow:0 10px 22px rgba(0,0,0,.10);
}
html,body{
  margin:0; height:100%;
  background:var(--bg); color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
  overflow:hidden;
  transition:background .25s,color .25s;
}
*{box-sizing:border-box}
.wrapper{
  height:100%;
  padding:2vh 2vw;
  display:flex;
  flex-direction:column;
  gap:1.2vh;
}
.topbar{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:1.5vw;
}
.brand{
  display:flex;
  flex-direction:column;
  gap:.6vh;
  min-width:0;
}
h1{
  margin:0;
  font-size:clamp(18px, 3.1vh, 34px);
  letter-spacing:.3px;
  font-weight:900;
  line-height:1.05;
}
.meta{
  display:flex;
  flex-wrap:wrap;
  gap:1.1vw;
  align-items:center;
  font-size:clamp(12px, 1.7vh, 18px);
  color:var(--muted);
}
.meta .clock{
  font-weight:900;
  color:var(--accent);
  font-size:clamp(14px, 2.2vh, 22px);
}
.pills{
  display:flex;
  flex-wrap:wrap;
  gap:.6vw;
  align-items:center;
  justify-content:flex-end;
}
.pill{
  background:var(--card);
  border:2px solid rgba(76,201,240,.25);
  padding:.7vh .9vw;
  border-radius:999px;
  font-weight:800;
  font-size:clamp(12px, 1.6vh, 18px);
  box-shadow:var(--shadow);
  color:var(--text);
  white-space:nowrap;
}
.pill strong{color:var(--accent)}
.theme-toggle{
  background:var(--card);
  border:2px solid var(--accent);
  color:var(--text);
  padding:.8vh 1vw;
  border-radius:14px;
  cursor:pointer;
  font-size:clamp(12px, 1.8vh, 18px);
  font-weight:900;
  transition:transform .18s, box-shadow .18s;
  box-shadow:var(--shadow);
}
.theme-toggle:hover{ transform:scale(1.05); }

.week-nav{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:3vw;
  padding:.6vh 1vw;
}
.week-nav button{
  background:transparent;
  color:var(--text);
  border:1px solid transparent;
  padding:.55vh 1vw;
  border-radius:12px;
  font-size:clamp(12px, 1.7vh, 18px);
  font-weight:700;
  cursor:pointer;
  transition:all .18s;
  opacity:.55;
}
.week-nav button:hover:not(:disabled){
  opacity:1;
  border-color:rgba(76,201,240,.35);
  background:rgba(76,201,240,.10);
}
.week-nav button:disabled{opacity:.18; cursor:not-allowed;}
.week-info{
  text-align:center;
  min-width:min(56vw, 560px);
  color:var(--accent);
}
.week-number{
  font-weight:900;
  font-size:clamp(14px, 2.2vh, 22px);
  line-height:1.1;
}
.week-date{
  margin-top:.2vh;
  color:var(--muted);
  font-weight:700;
  font-size:clamp(11px, 1.4vh, 16px);
}

.panel{
  flex:1;
  min-height:0;
  background:var(--card);
  border-radius:22px;
  padding:1.6vh 1.5vw;
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  gap:1.1vh;
}

/* Vorlagen / Legend */
.legend{
  display:flex;
  gap:.6vw;
  align-items:center;
  flex-wrap:wrap;
  min-height:0;
}
.legend-title{
  font-weight:900;
  color:var(--accent);
  margin-right:.4vw;
  white-space:nowrap;
}
.legend-scroll{
  display:flex;
  gap:.6vw;
  align-items:center;
  overflow:auto;
  padding-bottom:.4vh;
  scrollbar-width:none;
  -ms-overflow-style:none;
  max-width:100%;
}
.legend-scroll::-webkit-scrollbar{display:none;}
.chip{
  display:inline-flex;
  align-items:center;
  gap:.5vw;
  padding:.55vh .75vw;
  border-radius:999px;
  font-weight:900;
  font-size:clamp(11px, 1.35vh, 15px);
  white-space:nowrap;
  border:2px solid rgba(255,255,255,.12);
  box-shadow:0 2px 10px rgba(0,0,0,.12);
}
.chip .mini{
  width:clamp(10px, .9vw, 14px);
  height:clamp(10px, .9vw, 14px);
  border-radius:50%;
  border:2px solid rgba(255,255,255,.7);
  flex:0 0 auto;
}
.chip .type{
  opacity:.75;
  font-weight:800;
}

/* Grid area: scrollt, damit der letzte Mitarbeiter nie abgeschnitten wird */
.gridwrap{
  flex:1;
  min-height:0;
  overflow-x:auto;
  overflow-y:hidden;
  border-radius:16px;
  border:3px solid var(--border);
  background:var(--border);
  scrollbar-width:thin;
}
.grid{
  display:grid;
  height:100%;
  grid-template-rows: var(--dayhead-h) repeat(var(--emp-count), 1fr);
  grid-template-columns:18vw repeat(6, 1fr);
  gap:2px;
  background:var(--border);
  min-width:980px; /* f√ºr TV/Beamer angenehm */
}
.grid-cell{
  background:var(--card);
  padding:.6vh .5vw;
  display:flex;
  flex-direction:row;
  flex-wrap:wrap;
  align-items:center;
  justify-content:center;
  gap:.35vw;
  position:relative;
  overflow:hidden;
  min-height:0;
}
.grid-header{
  background:var(--header);
  font-weight:900;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:.25vh;
  padding:.9vh .6vw;
  position:sticky; /* sticky f√ºr Header-Zeile / erste Spalte */
  z-index:3;
}
.grid-header.top{ top:0; z-index:5; }
.grid-header.left{ left:0; z-index:4; }
.grid-header.corner{ top:0; left:0; z-index:6; }

.dayName{
  font-size:clamp(12px, 1.9vh, 22px);
  font-weight:950;
  color:var(--accent);
  line-height:1.05;
}
.dayDate{
  font-size:clamp(10px, 1.25vh, 14px);
  color:var(--muted);
  font-weight:800;
}
.emp-header{
  flex-direction:row;
  justify-content:flex-start;
  gap:.7vw;
  padding-left:1vw;
}
.dot{
  width:clamp(12px, 1.1vw, 18px);
  height:clamp(12px, 1.1vw, 18px);
  border-radius:50%;
  border:2px solid rgba(255,255,255,.85);
  flex:0 0 auto;
}
.emp-name{
  font-size:clamp(12px, 1.6vh, 18px);
  font-weight:950;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:14vw;
}
.box{
  padding:clamp(4px,.65vh,9px) clamp(8px,.8vw,14px);
  border-radius:10px;
  font-weight:950;
  font-size:clamp(11px, 1.25vh, 15px);
  line-height:1.1;
  text-align:center;
  box-shadow:0 2px 10px rgba(0,0,0,.15);
  white-space:nowrap;
  flex:0 0 auto;
}

.today-cell{
  outline:5px solid var(--today);
  box-shadow:0 0 42px var(--today);
  animation:pulse 2.5s ease-in-out infinite;
}
.today-cell::before{
  content:"";
  position:absolute; inset:0;
  background:var(--today);
  opacity:.12;
  pointer-events:none;
  z-index:1;
  border-radius:0;
}
.today-cell > *{ position:relative; z-index:2; }
@keyframes pulse{
  0%,100%{ box-shadow:0 0 26px var(--today); outline-width:5px; }
  50%{ box-shadow:0 0 54px var(--today); outline-width:6px; }
}

/* Banner */
.banner{
  position:fixed;
  left:50%;
  top:1.6vh;
  transform:translateX(-50%);
  background:rgba(249,65,68,.95);
  border:2px solid rgba(255,255,255,.25);
  border-radius:16px;
  padding:1.2vh 2.2vw;
  font-weight:950;
  display:none;
  box-shadow:0 18px 36px rgba(0,0,0,.40);
  font-size:clamp(14px, 2.0vh, 22px);
  z-index:20;
}

/* Mobile: weniger Platz oben, grid darf scrollen */
@media (max-width: 820px){
  .wrapper{ padding:1.2vh 3vw; }
  .grid{ min-width:760px; }
  .emp-name{ max-width:44vw; }
}
</style>
</head>
<body>
<div class="wrapper">

  <div class="topbar">
    <div class="brand">
      <h1>Daer ‚Äì Dienstleister</h1>
      <div class="meta">
        <div class="clock" id="clock">--:--:--</div>
        <div id="month"></div>
        <div id="weather"></div>
      </div>
    </div>

    <div class="pills">
      <div class="pill" id="statsPill">Einsatz: <strong>0</strong> ‚Ä¢ Urlaub: <strong>0</strong> ‚Ä¢ Krank: <strong>0</strong> ‚Ä¢ Frei: <strong>0</strong></div>
      <button class="theme-toggle" id="themeToggle" title="Hell/Dunkel">üåì</button>
    </div>
  </div>

  <div class="week-nav">
    <button id="prevWeek">‚Üê Vorherige</button>
    <div class="week-info">
      <div class="week-number" id="weekNumber">Woche 1</div>
      <div class="week-date" id="weekDate">‚Äì</div>
    </div>
    <button id="nextWeek">N√§chste ‚Üí</button>
  </div>

  <div class="panel" id="weekContainer">
    <div class="legend" aria-label="Vorlagen">
      <div class="legend-title">Vorlagen:</div>
      <div class="legend-scroll" id="legendScroll">
        <span class="chip" style="background:rgba(76,201,240,.12); border-color:rgba(76,201,240,.25);">
          <span class="mini" style="background:var(--accent)"></span>
          L√§dt‚Ä¶
        </span>
      </div>
    </div>

    <div class="gridwrap" id="gridWrap">
      <!-- Grid kommt hier rein -->
    </div>
  </div>
</div>

<div class="banner" id="banner">üö® Krank gemeldet</div>

<script type="module">
const firebaseConfig = {
  apiKey: "AIzaSyDgjZr2yrOrbl2dUoY26fl8EenOL0Hh-H4",
  authDomain: "daer-b525e.firebaseapp.com",
  databaseURL: "https://daer-b525e-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "daer-b525e",
  storageBucket: "daer-b525e.firebasestorage.app",
  messagingSenderId: "992532370590",
  appId: "1:992532370590:web:185d52a3dc6338b3ee978f"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const planRef = ref(db,"dienstplan");
const eventsRef = query(ref(db,"events"), limitToLast(1));

const $ = (id)=>document.getElementById(id);

let currentWeekIndex = 0;
let planData = null;

// Theme Toggle
const savedTheme = localStorage.getItem("tv-theme");
if(savedTheme === "light") document.body.classList.add("light");
$("themeToggle").onclick = () => {
  document.body.classList.toggle("light");
  localStorage.setItem("tv-theme", document.body.classList.contains("light") ? "light" : "dark");
};

function updateClock(){
  const now=new Date();
  $("clock").textContent = now.toLocaleTimeString("de-DE");
}
setInterval(updateClock,1000);
updateClock();

function updateMonth(startISO){
  if(!startISO) return;
  const d=new Date(startISO);
  $("month").textContent = d.toLocaleDateString("de-DE",{month:"long", year:"numeric"});
}

async function loadWeather(){
  const url="https://api.open-meteo.com/v1/forecast?latitude=52.69&longitude=13.17&current_weather=true";
  try{
    const res=await fetch(url,{cache:"no-store"});
    const j=await res.json();
    $("weather").textContent = "Velten üå§ " + Math.round(j.current_weather.temperature) + "¬∞C";
  }catch(e){
    $("weather").textContent = "Velten üå§ ‚Ä¶";
  }
}
setInterval(loadWeather, 10*60*1000);
loadWeather();

function todayISO(){
  const d=new Date();
  const p=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
}
function diffDays(aIso,bIso){
  const a=new Date(aIso), b=new Date(bIso);
  return Math.floor((b-a)/(1000*60*60*24));
}
function addDays(iso, days){
  if(!iso) return "";
  const d=new Date(iso);
  d.setDate(d.getDate()+days);
  return d.toISOString().slice(0,10);
}
function formatDate(iso){
  if(!iso) return "";
  const d=new Date(iso);
  const day=String(d.getDate()).padStart(2,"0");
  const month=String(d.getMonth()+1).padStart(2,"0");
  const year=d.getFullYear();
  return `${day}.${month}.${year}`;
}
function isDark(hex){
  if(!hex || hex[0]!=="#" || hex.length<7) return false;
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  const lum=(0.2126*r+0.7152*g+0.0722*b)/255;
  return lum<0.55;
}
function esc(s){
  return (s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}

function findCurrentWeek(startDate){
  const age = diffDays(startDate, todayISO());
  if(age >= 0 && age < 28) return Math.floor(age/7);
  return 0;
}

function renderLegend(templates){
  const wrap = $("legendScroll");
  wrap.innerHTML = "";
  if(!templates || !templates.length){
    wrap.innerHTML = `<span class="chip" style="background:rgba(76,201,240,.10);border-color:rgba(76,201,240,.25)">
      <span class="mini" style="background:var(--accent)"></span>Keine Vorlagen
    </span>`;
    return;
  }
  // Immer sichtbar: wenn viele, kann man horizontal scrollen (oder auf gro√üen Screens bricht es um)
  templates.forEach(t=>{
    const bg = t.color || "#4cc9f0";
    const txt = isDark(bg) ? "#fff" : "#081018";
    const el = document.createElement("span");
    el.className = "chip";
    el.style.background = bg;
    el.style.color = txt;
    el.innerHTML = `<span class="mini" style="background:rgba(255,255,255,.85)"></span>
      ${esc(t.name)} <span class="type">‚Ä¢ ${esc(t.type || "einsatz")}</span>`;
    wrap.appendChild(el);
  });
}

function renderWeek(){
  if(!planData) return;

  const weekStart = addDays(planData.start, currentWeekIndex * 7);
  const weekEnd = addDays(weekStart, 5);

  $("weekNumber").textContent = `Woche ${currentWeekIndex + 1}`;
  $("weekDate").textContent = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
  updateMonth(planData.start);

  const age = planData.start ? diffDays(planData.start, todayISO()) : -1;
  const todayWeek = (age>=0 && age<28) ? Math.floor(age/7) : -1;
  const todayDay  = (age>=0 && age<28) ? (age%7) : -1;

  const templates = planData.templates || [];
  const tByName = new Map(templates.map(t=>[t.name,t]));
  renderLegend(templates);

  let stats = {einsatz:0, urlaub:0, krank:0, frei:0};

  const grid = document.createElement("div");
  grid.className = "grid";

  const dayNames = ["Mo","Di","Mi","Do","Fr","Sa"];

  // Corner
  const corner = document.createElement("div");
  corner.className = "grid-header emp-header top left corner";
  corner.innerHTML = `<span class="emp-name">Mitarbeiter</span>`;
  grid.appendChild(corner);

  // Top header
  dayNames.forEach((dayName, dayIdx)=>{
    const dateISO = addDays(weekStart, dayIdx);
    const cell = document.createElement("div");
    cell.className = "grid-header top";
    cell.innerHTML = `<div class="dayName">${dayName}</div><div class="dayDate">${formatDate(dateISO)}</div>`;
    grid.appendChild(cell);
  });

  // Rows
  const EMP_COUNT = 12;
  const employees = (planData.employees||[]).slice(0, EMP_COUNT);
  document.documentElement.style.setProperty('--emp-count', EMP_COUNT);
  employees.forEach((emp,r)=>{
    const empCell = document.createElement("div");
    empCell.className = "grid-header emp-header left";
    empCell.innerHTML = `<span class="dot" style="background:${emp.color||"#4cc9f0"}"></span>
                         <span class="emp-name">${esc(emp.name)}</span>`;
    grid.appendChild(empCell);

    for(let d=0; d<6; d++){
      const k = `${currentWeekIndex}-${r}-${d}`;
      const cell = document.createElement("div");
      cell.className = "grid-cell";

      if(currentWeekIndex === todayWeek && d === todayDay){
        cell.classList.add("today-cell");
      }

      const items = (planData.assignments && planData.assignments[k]) ? planData.assignments[k] : [];
      items.forEach(name=>{
        const tpl = tByName.get(name) || {name, type:"einsatz", color: emp.color || "#4cc9f0"};
        const box = document.createElement("div");
        box.className = "box";
        box.style.background = tpl.color || (emp.color||"#4cc9f0");
        box.style.color = isDark(box.style.background) ? "#fff" : "#081018";
        box.textContent = name;

        if(tpl.type==="urlaub") stats.urlaub++;
        else if(tpl.type==="krank") stats.krank++;
        else if(tpl.type==="frei") stats.frei++;
        else stats.einsatz++;

        cell.appendChild(box);
      });

      grid.appendChild(cell);
    }
  });

  const gridWrap = $("gridWrap");
  gridWrap.innerHTML = "";
  gridWrap.appendChild(grid);

  $("statsPill").innerHTML = `Einsatz: <strong>${stats.einsatz}</strong> ‚Ä¢ Urlaub: <strong>${stats.urlaub}</strong> ‚Ä¢ Krank: <strong>${stats.krank}</strong> ‚Ä¢ Frei: <strong>${stats.frei}</strong>`;

  $("prevWeek").disabled = currentWeekIndex === 0;
  $("nextWeek").disabled = currentWeekIndex === 3;

  document.documentElement.requestFullscreen?.().catch(()=>{});
}

// Navigation
$("prevWeek").onclick = ()=>{ if(currentWeekIndex>0){ currentWeekIndex--; renderWeek(); } };
$("nextWeek").onclick = ()=>{ if(currentWeekIndex<3){ currentWeekIndex++; renderWeek(); } };

document.addEventListener("keydown",(e)=>{
  if(e.key==="ArrowLeft" && currentWeekIndex>0){ currentWeekIndex--; renderWeek(); }
  if(e.key==="ArrowRight" && currentWeekIndex<3){ currentWeekIndex++; renderWeek(); }
});

// Load plan
onValue(planRef,(snap)=>{
  if(!snap.exists()) return;
  planData = snap.val();
  currentWeekIndex = findCurrentWeek(planData.start);
  renderWeek();
});

// Events banner
onValue(eventsRef,(snap)=>{
  if(!snap.exists()) return;
  const obj = snap.val();
  const lastKey = Object.keys(obj)[0];
  const ev = obj[lastKey];
  if(ev?.type==="krank"){
    const b=$("banner");
    b.textContent = `üö® Krank gemeldet: ${ev.label} (${new Date(ev.at).toLocaleTimeString("de-DE")})`;
    b.style.display="block";
    setTimeout(()=>b.style.display="none", 8000);
  }
});
</script>
</body>
</html>
