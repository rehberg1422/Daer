<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Daer â€“ Dienstleister | TV V3</title>
<style>
html,body{margin:0;height:100%;background:#0b1020;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
.wrapper{height:100%;padding:2vh 2vw;box-sizing:border-box}
.top{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
h1{margin:0;font-size:3vh;letter-spacing:.5px}
.meta{font-size:1.4vh;opacity:.82;text-align:right}
.meta .clock{font-size:2.0vh;font-weight:800}
.weeks{
  margin-top:2vh; height:84vh;
  display:grid; grid-template-columns:repeat(2,1fr); grid-template-rows:repeat(2,1fr);
  gap:1.6vh;
}
.week{background:#141c30;border-radius:16px;padding:1vh 1vw;display:flex;flex-direction:column}
.weekTitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8vh;font-size:1.6vh;font-weight:800}
.grid{flex:1;display:grid;grid-template-columns:12vw repeat(6,1fr);border:1px solid #2b3a55;border-radius:12px;overflow:hidden}
.grid > div{border:1px solid #2b3a55;padding:.55vh .45vw;font-size:1.05vh;display:flex;align-items:center;justify-content:center;text-align:center}
.head{background:#1c2842;font-weight:900}
.emp{justify-content:flex-start;gap:8px;padding-left:.6vw;font-weight:900}
.dot{width:10px;height:10px;border-radius:50%}
.box{width:100%;padding:.25vh .35vw;border-radius:10px;font-weight:900}
.todayGlow{
  position:relative;
  outline:3px solid rgba(0,255,204,.85);
  box-shadow:0 0 24px rgba(0,255,204,.45);
  animation:pulse 2.2s ease-in-out infinite;
}
@keyframes pulse{0%,100%{box-shadow:0 0 18px rgba(0,255,204,.25)}50%{box-shadow:0 0 32px rgba(0,255,204,.55)}}
.stats{
  position:fixed;right:2vw;bottom:1.2vh;
  font-size:1.35vh;opacity:.85;background:rgba(20,28,48,.65);
  border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:8px 10px;
}
.banner{
  position:fixed;left:50%;top:1.2vh;transform:translateX(-50%);
  background:rgba(249,65,68,.92);border:1px solid rgba(255,255,255,.18);
  border-radius:16px;padding:10px 14px;font-weight:900;display:none;
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}
</style>
</head>
<body>
<div class="wrapper">
  <div class="top">
    <div>
      <h1>Daer â€“ Dienstleister</h1>
      <div style="font-size:1.35vh;opacity:.75">Dienstplan â€¢ 4 Wochen â€¢ Live</div>
    </div>
    <div class="meta">
      <div class="clock" id="clock"></div>
      <div id="month"></div>
      <div id="weather"></div>
    </div>
  </div>

  <div class="weeks" id="weeks"></div>
</div>

<div class="banner" id="banner">ðŸš¨ Krank gemeldet</div>
<div class="stats" id="stats">â€¦</div>

<script type="module">
const firebaseConfig = {
  apiKey: "AIzaSyDgjZr2yrOrbl2dUoY26fl8EenOL0Hh-H4",
  authDomain: "daer-b525e.firebaseapp.com",
  databaseURL: "https://daer-b525e-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "daer-b525e",
  storageBucket: "daer-b525e.firebasestorage.app",
  messagingSenderId: "992532370590",
  appId: "1:992532370590:web:185d52a3dc6338b3ee978f"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const planRef = ref(db,"dienstplan");
const eventsRef = query(ref(db,"events"), limitToLast(1));

const $ = (id)=>document.getElementById(id);

function updateClock(){
  const now=new Date();
  $("clock").textContent = now.toLocaleTimeString("de-DE");
}
setInterval(updateClock,1000); updateClock();

function updateMonth(startISO){
  if(!startISO) return;
  const d=new Date(startISO);
  $("month").textContent = d.toLocaleDateString("de-DE",{month:"long", year:"numeric"});
}

async function loadWeather(){
  // Velten (ungefÃ¤hr)
  const url="https://api.open-meteo.com/v1/forecast?latitude=52.69&longitude=13.17&current_weather=true";
  try{
    const res=await fetch(url,{cache:"no-store"});
    const j=await res.json();
    $("weather").textContent = "Velten ðŸŒ¤ " + Math.round(j.current_weather.temperature) + "Â°C";
  }catch(e){
    $("weather").textContent = "Velten ðŸŒ¤ â€¦";
  }
}
setInterval(loadWeather, 10*60*1000); loadWeather();

function todayISO(){
  const d=new Date(); const p=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
}
function diffDays(aIso,bIso){
  const a=new Date(aIso); const b=new Date(bIso);
  return Math.floor((b-a)/(1000*60*60*24));
}

function render(plan){
  const weeksEl = $("weeks");
  weeksEl.innerHTML = "";
  updateMonth(plan.start);

  const age = plan.start ? diffDays(plan.start, todayISO()) : -1;
  const currentWeek = (age>=0 && age<28) ? Math.floor(age/7) : -1;
  const currentDay  = (age>=0 && age<28) ? (age%7) : -1;

  const templates = plan.templates || [];
  const tByName = new Map(templates.map(t=>[t.name,t]));

  let stats = {einsatz:0, urlaub:0, krank:0, frei:0};

  for(let w=0; w<4; w++){
    const week = document.createElement("div");
    week.className="week";
    const weekStart = addDays(plan.start, w*7);
    week.innerHTML = `<div class="weekTitle"><span>Woche ${w+1}</span><span style="opacity:.7;font-weight:700">${weekStart}</span></div>`;

    const grid = document.createElement("div");
    grid.className="grid";

    grid.appendChild(head("Mitarbeiter"));
    ["Mo","Di","Mi","Do","Fr","Sa"].forEach(d=>grid.appendChild(head(d)));

    (plan.employees||[]).forEach((emp,r)=>{
      const empCell = document.createElement("div");
      empCell.className="emp head";
      empCell.innerHTML = `<span class="dot" style="background:${emp.color}"></span><span>${escapeHtml(emp.name)}</span>`;
      grid.appendChild(empCell);

      for(let d=0; d<6; d++){
        const k = `${w}-${r}-${d}`;
        const cell = document.createElement("div");
        const items = (plan.assignments && plan.assignments[k]) ? plan.assignments[k] : [];

        if(w===currentWeek && d===currentDay){ cell.classList.add("todayGlow"); }

        if(items.length){
          // show stacked boxes (max 2)
          items.slice(0,2).forEach(name=>{
            const tpl = tByName.get(name) || {name, type:"einsatz", color: emp.color};
            const box = document.createElement("div");
            box.className="box";
            box.style.background = tpl.color;
            box.style.color = isDark(tpl.color) ? "#fff" : "#081018";
            box.textContent = name;

            // stats
            if(tpl.type==="urlaub") stats.urlaub++;
            else if(tpl.type==="krank") stats.krank++;
            else if(tpl.type==="frei") stats.frei++;
            else stats.einsatz++;

            cell.appendChild(box);
          });
        }

        grid.appendChild(cell);
      }
    });

    week.appendChild(grid);
    weeksEl.appendChild(week);
  }

  $("stats").textContent =
    `Einsatz: ${stats.einsatz} â€¢ Urlaub: ${stats.urlaub} â€¢ Krank: ${stats.krank} â€¢ Frei: ${stats.frei}`;

  // auto fullscreen
  document.documentElement.requestFullscreen?.().catch(()=>{});
}

function head(t){
  const d=document.createElement("div");
  d.className="head";
  d.textContent=t;
  return d;
}
function escapeHtml(s){
  return (s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function addDays(iso, days){
  if(!iso) return "";
  const d=new Date(iso); d.setDate(d.getDate()+days);
  return d.toISOString().slice(0,10);
}
function isDark(hex){
  if(!hex || hex[0]!=="#" || hex.length<7) return false;
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  const lum=(0.2126*r+0.7152*g+0.0722*b)/255;
  return lum<0.55;
}

// live plan
onValue(planRef,(snap)=>{ if(snap.exists()) render(snap.val()); });

// last event banner
onValue(eventsRef,(snap)=>{
  if(!snap.exists()) return;
  const obj = snap.val();
  const lastKey = Object.keys(obj)[0];
  const ev = obj[lastKey];
  if(ev?.type==="krank"){
    const b=$("banner");
    b.textContent = `ðŸš¨ Krank gemeldet: ${ev.label} (${new Date(ev.at).toLocaleTimeString("de-DE")})`;
    b.style.display="block";
    setTimeout(()=>b.style.display="none", 8000);
  }
});
</script>
</body>
</html>
