<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Daer ‚Äì Dienstleister | TV</title>
<style>
:root {
  --bg: #e8ecf1;
  --card-bg: #ffffff;
  --text: #1a202c;
  --header-bg: #d4f1f4;
  --border: #b8dadd;
  --accent: #00acc1;
  --today-glow: #00acc1;
  --today-bg: #e0f7fa;
}

body.dark {
  --bg: #0b1020;
  --card-bg: #141c30;
  --text: #ffffff;
  --header-bg: #1c2842;
  --border: #2b3a55;
  --accent: #4cc9f0;
  --today-glow: #4cc9f0;
  --today-bg: rgba(76,201,240,0.15);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: var(--bg);
  color: var(--text);
  font-family: 'Arial Black', Arial, sans-serif;
  transition: background 0.3s, color 0.3s;
}

.wrapper {
  height: 100%;
  display: flex;
  flex-direction: column;
  padding: 1.5vh 2.5vw 0.5vh 2.5vw;
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1vh;
  padding: 0 0.5vw;
}

.header-left h1 {
  font-size: 3.2vh;
  font-weight: 900;
  letter-spacing: 0.5px;
  margin-bottom: 0.3vh;
}

.header-info {
  display: flex;
  gap: 2vw;
  font-size: 1.6vh;
  font-weight: 700;
  opacity: 0.85;
}

.clock {
  color: var(--accent);
  font-size: 2vh;
  font-weight: 900;
}

.theme-toggle {
  background: var(--card-bg);
  border: 2px solid var(--accent);
  color: var(--accent);
  padding: 0.8vh 1.5vw;
  border-radius: 8px;
  font-size: 1.8vh;
  font-weight: 900;
  cursor: pointer;
  transition: all 0.2s;
}

.theme-toggle:hover {
  background: var(--accent);
  color: white;
  transform: scale(1.05);
}

/* Week Navigation */
.week-nav {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4vw;
  margin-bottom: 0.8vh;
  padding: 0.4vh 0;
}

.week-nav button {
  background: transparent;
  color: var(--text);
  border: none;
  padding: 0.4vh 1.5vw;
  border-radius: 6px;
  font-size: 1.8vh;
  font-weight: 700;
  cursor: pointer;
  opacity: 0.5;
  transition: all 0.2s;
}

.week-nav button:hover:not(:disabled) {
  opacity: 1;
  background: rgba(0,172,193,0.1);
}

.week-nav button:disabled {
  opacity: 0.2;
  cursor: not-allowed;
}

.week-info {
  text-align: center;
  min-width: 30vw;
}

.week-number {
  font-size: 2.2vh;
  font-weight: 900;
  color: var(--accent);
  margin-bottom: 0.2vh;
}

.week-date {
  font-size: 1.4vh;
  font-weight: 700;
  opacity: 0.7;
}

/* Grid Container */
.grid-container {
  flex: 1;
  background: var(--card-bg);
  border-radius: 12px;
  padding: 0.8vh 0.8vw;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  min-height: 0;
  overflow: hidden;
}

.grid {
  flex: 1;
  display: grid;
  grid-template-columns: 14vw repeat(6, 1fr);
  gap: 1px;
  background: var(--border);
  border: 2px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  min-height: 0;
}

/* Grid Cells */
.grid-cell {
  background: var(--card-bg);
  padding: 0.5vh 0.3vw;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  gap: 0.35vh;
  position: relative;
  min-height: 0;
  overflow: hidden;
}

.grid-header {
  background: var(--header-bg);
  font-weight: 900;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0.6vh 0.3vw;
  gap: 0.15vh;
}

/* Day Headers */
.day-header {
  font-size: 1.6vh;
  color: var(--accent);
}

.day-date {
  font-size: 1.1vh;
  opacity: 0.75;
  font-weight: 700;
}

/* Employee Headers */
.emp-header {
  flex-direction: row;
  justify-content: flex-start;
  gap: 0.5vw;
  padding-left: 0.6vw;
}

.emp-dot {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 3px solid var(--text);
  flex-shrink: 0;
}

.emp-name {
  font-size: 1.5vh;
  font-weight: 900;
  text-align: left;
  line-height: 1.1;
}

/* Entry Boxes - DYNAMISCH! */
.entry-box {
  width: 100%;
  padding: 0.4vh 0.3vw;
  border-radius: 5px;
  font-weight: 900;
  text-align: center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  border: 2px solid rgba(0,0,0,0.15);
  line-height: 1.15;
  overflow: hidden;
  position: relative;
  flex-shrink: 0;
}

/* Dynamische Font-Gr√∂√üe basierend auf Anzahl der Eintr√§ge */
.entry-box.size-1 { font-size: 1.3vh; } /* 1 Eintrag */
.entry-box.size-2 { font-size: 1.2vh; } /* 2 Eintr√§ge */
.entry-box.size-3 { font-size: 1.1vh; } /* 3 Eintr√§ge */
.entry-box.size-4 { font-size: 1.0vh; } /* 4 Eintr√§ge */
.entry-box.size-5 { font-size: 0.95vh; } /* 5+ Eintr√§ge */

/* Scrollbar f√ºr Zellen mit VIELEN Eintr√§gen */
.grid-cell.has-scroll {
  overflow-y: auto;
}

.grid-cell.has-scroll::-webkit-scrollbar {
  width: 3px;
}

.grid-cell.has-scroll::-webkit-scrollbar-track {
  background: transparent;
}

.grid-cell.has-scroll::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 2px;
}

/* HEUTE Markierung - SEHR DEUTLICH */
.today-cell {
  outline: 4px solid var(--today-glow);
  outline-offset: -4px;
  background: var(--today-bg) !important;
  position: relative;
  animation: pulse-today 2s ease-in-out infinite;
}

.today-cell::before {
  content: 'HEUTE';
  position: absolute;
  top: 2px;
  right: 2px;
  background: var(--today-glow);
  color: white;
  padding: 1px 4px;
  border-radius: 3px;
  font-size: 0.7vh;
  font-weight: 900;
  z-index: 10;
  letter-spacing: 0.5px;
}

@keyframes pulse-today {
  0%, 100% {
    outline-color: var(--today-glow);
    box-shadow: 0 0 15px var(--today-glow);
  }
  50% {
    outline-color: var(--today-glow);
    box-shadow: 0 0 25px var(--today-glow);
  }
}

/* Stats */
.stats {
  position: fixed;
  right: 2vw;
  bottom: 0.5vh;
  background: var(--card-bg);
  border: 2px solid var(--accent);
  border-radius: 10px;
  padding: 0.6vh 1.2vw;
  font-size: 1.4vh;
  font-weight: 900;
  color: var(--accent);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  z-index: 100;
}

/* Banner */
.banner {
  position: fixed;
  left: 50%;
  top: 1.5vh;
  transform: translateX(-50%);
  background: #f44336;
  color: white;
  padding: 1vh 2vw;
  border-radius: 10px;
  font-weight: 900;
  font-size: 1.8vh;
  display: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 1000;
}

.banner.show {
  display: block;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from { transform: translate(-50%, -100%); opacity: 0; }
  to { transform: translate(-50%, 0); opacity: 1; }
}

/* Loading State */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  font-size: 3vh;
  font-weight: 900;
  color: var(--accent);
}
</style>
</head>
<body>

<div class="wrapper">
  
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1>Daer ‚Äì Dienstleister</h1>
      <div class="header-info">
        <span class="clock" id="clock">00:00:00</span>
        <span id="month">-</span>
        <span id="weather">-</span>
      </div>
    </div>
    <button class="theme-toggle" id="themeToggle">üåì</button>
  </div>

  <!-- Week Navigation -->
  <div class="week-nav">
    <button id="prevWeek">‚Üê Vorherige</button>
    <div class="week-info">
      <div class="week-number" id="weekNumber">Woche 1</div>
      <div class="week-date" id="weekDate">-</div>
    </div>
    <button id="nextWeek">N√§chste ‚Üí</button>
  </div>

  <!-- Grid -->
  <div class="grid-container">
    <div class="grid" id="grid">
      <div class="loading">Lade Dienstplan...</div>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats" id="stats">-</div>

</div>

<!-- Banner -->
<div class="banner" id="banner"></div>

<script type="module">
const firebaseConfig = {
  apiKey: "AIzaSyDgjZr2yrOrbl2dUoY26fl8EenOL0Hh-H4",
  authDomain: "daer-b525e.firebaseapp.com",
  databaseURL: "https://daer-b525e-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "daer-b525e",
  storageBucket: "daer-b525e.firebasestorage.app",
  messagingSenderId: "992532370590",
  appId: "1:992532370590:web:185d52a3dc6338b3ee978f"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const planRef = ref(db, "dienstplan");
const eventsRef = query(ref(db, "events"), limitToLast(1));

const $ = id => document.getElementById(id);

let currentWeek = 0;
let planData = null;

// Theme
const savedTheme = localStorage.getItem('tv-theme') || 'light';
if (savedTheme === 'dark') document.body.classList.add('dark');

$('themeToggle').onclick = () => {
  document.body.classList.toggle('dark');
  const theme = document.body.classList.contains('dark') ? 'dark' : 'light';
  localStorage.setItem('tv-theme', theme);
};

// Clock
function updateClock() {
  const now = new Date();
  $('clock').textContent = now.toLocaleTimeString('de-DE');
}
setInterval(updateClock, 1000);
updateClock();

// Weather
async function loadWeather() {
  try {
    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=52.69&longitude=13.17&current_weather=true', {cache: 'no-store'});
    const data = await res.json();
    $('weather').textContent = `Velten üå§ ${Math.round(data.current_weather.temperature)}¬∞C`;
  } catch(e) {
    $('weather').textContent = 'Velten üå§';
  }
}
setInterval(loadWeather, 10 * 60 * 1000);
loadWeather();

// Helpers
const todayISO = () => {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
};

const addDays = (iso, days) => {
  const d = new Date(iso);
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0, 10);
};

const formatDate = (iso) => {
  const d = new Date(iso);
  return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
};

const diffDays = (a, b) => {
  const da = new Date(a);
  const db = new Date(b);
  return Math.floor((db - da) / (1000 * 60 * 60 * 24));
};

const isDark = (hex) => {
  if (!hex || hex[0] !== '#') return false;
  const r = parseInt(hex.slice(1,3), 16);
  const g = parseInt(hex.slice(3,5), 16);
  const b = parseInt(hex.slice(5,7), 16);
  return (0.2126*r + 0.7152*g + 0.0722*b) / 255 < 0.6;
};

const esc = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

// Find current week
function findCurrentWeek(startDate) {
  const age = diffDays(startDate, todayISO());
  if (age >= 0 && age < 28) return Math.floor(age / 7);
  return 0;
}

// Render Week
function renderWeek() {
  if (!planData) return;
  
  const grid = $('grid');
  grid.innerHTML = '';
  
  const weekStart = addDays(planData.start, currentWeek * 7);
  const weekEnd = addDays(weekStart, 5);
  
  $('weekNumber').textContent = `Woche ${currentWeek + 1}`;
  $('weekDate').textContent = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
  $('month').textContent = new Date(planData.start).toLocaleDateString('de-DE', {month: 'long', year: 'numeric'});
  
  const age = diffDays(planData.start, todayISO());
  const todayWeek = (age >= 0 && age < 28) ? Math.floor(age / 7) : -1;
  const todayDay = (age >= 0 && age < 28) ? age % 7 : -1;
  
  const templates = new Map((planData.templates || []).map(t => [t.name, t]));
  let stats = {einsatz: 0, urlaub: 0, krank: 0, frei: 0};
  
  const days = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
  const employees = planData.employees || [];
  
  // Calculate grid rows dynamically
  const totalRows = employees.length + 1;
  grid.style.gridTemplateRows = `auto repeat(${employees.length}, 1fr)`;
  
  // Header Row
  const headerCell = document.createElement('div');
  headerCell.className = 'grid-header emp-header';
  headerCell.innerHTML = '<span class="emp-name">Mitarbeiter</span>';
  grid.appendChild(headerCell);
  
  days.forEach((day, idx) => {
    const dateISO = addDays(weekStart, idx);
    const cell = document.createElement('div');
    cell.className = 'grid-header';
    cell.innerHTML = `<div class="day-header">${day}</div><div class="day-date">${formatDate(dateISO)}</div>`;
    grid.appendChild(cell);
  });
  
  // Employee Rows
  employees.forEach((emp, r) => {
    const empCell = document.createElement('div');
    empCell.className = 'grid-header emp-header';
    empCell.innerHTML = `<span class="emp-dot" style="background:${emp.color}"></span><span class="emp-name">${esc(emp.name)}</span>`;
    grid.appendChild(empCell);
    
    for (let d = 0; d < 6; d++) {
      const key = `${currentWeek}-${r}-${d}`;
      const cell = document.createElement('div');
      cell.className = 'grid-cell';
      
      // Today marker
      if (currentWeek === todayWeek && d === todayDay) {
        cell.classList.add('today-cell');
      }
      
      const items = planData.assignments?.[key] || [];
      
      // Dynamische Schriftgr√∂√üe basierend auf Anzahl
      const sizeClass = items.length === 0 ? 'size-1' :
                       items.length === 1 ? 'size-1' :
                       items.length === 2 ? 'size-2' :
                       items.length === 3 ? 'size-3' :
                       items.length === 4 ? 'size-4' : 'size-5';
      
      // Scroll aktivieren bei mehr als 6 Eintr√§gen
      if (items.length > 6) {
        cell.classList.add('has-scroll');
      }
      
      items.forEach(name => {
        const tpl = templates.get(name) || {name, type: 'einsatz', color: emp.color};
        const box = document.createElement('div');
        box.className = `entry-box ${sizeClass}`;
        box.style.background = tpl.color;
        box.style.color = isDark(tpl.color) ? '#fff' : '#000';
        box.textContent = name;
        
        // Stats
        if (tpl.type === 'urlaub') stats.urlaub++;
        else if (tpl.type === 'krank') stats.krank++;
        else if (tpl.type === 'frei') stats.frei++;
        else stats.einsatz++;
        
        cell.appendChild(box);
      });
      
      grid.appendChild(cell);
    }
  });
  
  $('stats').textContent = `Einsatz: ${stats.einsatz} ‚Ä¢ Urlaub: ${stats.urlaub} ‚Ä¢ Krank: ${stats.krank} ‚Ä¢ Frei: ${stats.frei}`;
  
  // Update buttons
  $('prevWeek').disabled = currentWeek === 0;
  $('nextWeek').disabled = currentWeek === 3;
  
  // Fullscreen
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen?.().catch(() => {});
  }
}

// Navigation
$('prevWeek').onclick = () => {
  if (currentWeek > 0) {
    currentWeek--;
    renderWeek();
  }
};

$('nextWeek').onclick = () => {
  if (currentWeek < 3) {
    currentWeek++;
    renderWeek();
  }
};

// Keyboard
document.addEventListener('keydown', e => {
  if (e.key === 'ArrowLeft' && currentWeek > 0) {
    currentWeek--;
    renderWeek();
  } else if (e.key === 'ArrowRight' && currentWeek < 3) {
    currentWeek++;
    renderWeek();
  }
});

// Load Data
onValue(planRef, snap => {
  if (snap.exists()) {
    planData = snap.val();
    currentWeek = findCurrentWeek(planData.start);
    renderWeek();
  }
});

// Events
onValue(eventsRef, snap => {
  if (!snap.exists()) return;
  const obj = snap.val();
  const lastKey = Object.keys(obj)[0];
  const ev = obj[lastKey];
  if (ev?.type === 'krank') {
    const b = $('banner');
    b.textContent = `üö® Krank gemeldet: ${ev.label} (${new Date(ev.at).toLocaleTimeString('de-DE')})`;
    b.classList.add('show');
    setTimeout(() => b.classList.remove('show'), 8000);
  }
});

// Auto-Refresh alle 5 Minuten
setInterval(() => location.reload(), 5 * 60 * 1000);
</script>

</body>
</html>
